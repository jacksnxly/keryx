# Security audit workflow for keryx
# Runs cargo-audit to check for known vulnerabilities in dependencies
#
# Industry best practices:
# - Runs on a schedule (daily) to catch new vulnerabilities
# - Runs on PRs that modify Cargo.toml or Cargo.lock
# - Uses rustsec/rustsec action for standardized reporting

name: Security Audit

on:
  # Run on PRs that modify dependencies
  pull_request:
    paths:
      - 'Cargo.toml'
      - 'Cargo.lock'
  
  # Run on pushes to main that modify dependencies
  push:
    branches:
      - main
    paths:
      - 'Cargo.toml'
      - 'Cargo.lock'
  
  # Run daily at 6 AM UTC to catch new vulnerabilities
  schedule:
    - cron: '0 6 * * *'
  
  # Allow manual triggering
  workflow_dispatch:

permissions:
  contents: read
  issues: write  # Required to create issues for vulnerabilities

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo-audit
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-audit
          key: ${{ runner.os }}-cargo-audit-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install cargo-audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit
          fi
      
      - name: Run security audit
        # --deny warnings: Fail the build if vulnerabilities are found
        # --ignore RUSTSEC-XXXX-XXXX: Add exceptions here if needed (with justification)
        run: cargo audit
        continue-on-error: false
      
      - name: Generate SARIF report
        if: failure()
        run: cargo audit --format json > audit-report.json || true
      
      - name: Upload audit report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 30
