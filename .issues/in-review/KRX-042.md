---
id: "KRX-042"
title: "Handle revwalk traversal errors more explicitly"
type: bug
status: in-review
priority: high
labels: ["error-handling", "silent-failure"]
created: "2026-01-26"
updated: "2026-01-26"
assignee: null
---

# Handle revwalk traversal errors more explicitly

## Problem
The `find_root_commit` function collects traversal errors but doesn't failâ€”it just warns and returns potentially incomplete results. The returned root commit may not be the actual root.

## Current Behavior
```rust
for oid_result in revwalk {
    match oid_result {
        Ok(oid) => root_oid = oid,
        Err(e) => {
            debug!("Revwalk error: {}", e);
            traversal_errors.push(e);
        }
    }
}

if !traversal_errors.is_empty() {
    warn!(/* ... */);
}

Ok(root_oid)  // Returns potentially wrong root!
```

## Expected Behavior
Be more explicit about partial failures. Consider failing in strict mode or returning a result type that indicates partial success.

## Acceptance Criteria
- [x] Traversal errors are handled appropriately
- [x] `--strict` mode fails if traversal errors occur
- [x] Warning clearly indicates the root commit may be incorrect
- [x] Consider returning `Result<Oid, PartialTraversalError>` type

## Technical Notes
**File:** `src/git/range.rs:88-106`

This affects `keryx init --from-history` which relies on finding the true repository root. Shallow clones, missing objects, or permission issues could cause partial traversal.

---

## Resolution

**Completed:** 2026-01-26

### Approach
Added `strict: bool` parameter to `find_root_commit` and `resolve_range` functions, following the existing pattern from `fetch_commits`. In strict mode, traversal errors cause the function to return a `TraversalIncomplete` error. In non-strict mode, a clear warning is displayed both via tracing and to stderr.

### Changes Made
- `src/error.rs`: Added `TraversalIncomplete` error variant with `partial_root` and `error_count` fields
- `src/git/range.rs`: Updated `find_root_commit` to accept `strict: bool` and fail on traversal errors when strict. Updated `resolve_range` to pass through strict parameter.
- `src/main.rs`: Updated three callers (`run_init_unreleased`, `run_init_from_history`, `run_generate`) to pass the strict flag
- `tests/range_test.rs`: Updated all `resolve_range` calls to include the new strict parameter

### Testing
- [x] Build passes (`cargo build`)
- [x] All 104 tests pass (`cargo test`)
- [x] No clippy warnings (`cargo clippy`)

---
*Solved by Claude Code*
