---
id: "KRX-025"
title: "Upgrade Claude envelope parse fallback from DEBUG to WARN level"
type: improvement
status: in-review
priority: high
labels: ["error-handling", "ux"]
created: "2026-01-26"
updated: "2026-01-26"
assignee: null
---

# Upgrade Claude envelope parse fallback from DEBUG to WARN level

## Context
When the Claude CLI response doesn't match the expected envelope format, the code falls back to raw parsing. This is logged at DEBUG level, meaning users without `--verbose` won't see it. This could indicate a Claude CLI version mismatch that users should know about.

## Current Implementation
In `src/claude/retry.rs:109-121`:

```rust
} else {
    // Fallback: treat as raw response
    tracing::debug!(
        "Could not parse as Claude CLI envelope, treating as raw response. \
         This may indicate a Claude CLI version mismatch."
    );
    response.to_string()
};
```

## Proposed Improvement
Log at WARN level so users are aware of the fallback behavior in normal operation.

## Acceptance Criteria
- [x] Fallback logs at WARN level instead of DEBUG
- [x] Warning includes actionable advice (e.g., check Claude CLI version)
- [x] Users see the warning in normal (non-verbose) output

## Technical Notes
**File:** `src/claude/retry.rs:109-121`

Suggested fix:
```rust
} else {
    tracing::warn!(
        "Could not parse as Claude CLI envelope - treating as raw response. \
         This may indicate a Claude CLI version mismatch. Consider running \
         'claude --version' to check your installation."
    );
    response.to_string()
};
```

---

## Resolution

**Completed:** 2026-01-26

### Approach
Changed the log level from `tracing::debug!` to `tracing::warn!` and enhanced the message with actionable advice telling users to check their Claude CLI version.

### Changes Made
- `src/claude/retry.rs:114-120`: Upgraded `tracing::debug!` to `tracing::warn!` with enhanced message including "Consider running 'claude --version' to check your installation."

### Testing
- [x] Build passes (`cargo check`)
- [x] All 146 tests pass (`cargo test`)
- [ ] Manual testing required (run keryx with mismatched Claude CLI version)

---
*Solved by Claude Code*
