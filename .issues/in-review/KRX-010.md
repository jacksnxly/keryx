---
id: "KRX-010"
title: "Add integration tests for commit range resolution"
type: task
status: in-review
priority: high
labels: [testing, critical-gap]
created: "2026-01-25"
updated: "2026-01-25"
assignee: "jacksnxly"
---

# Add integration tests for commit range resolution

## Context
The `resolve_range` function in `src/git/range.rs` has no tests. The file explicitly notes tests are needed in a placeholder module.

## Current State
In `src/git/range.rs:95-98`:
```rust
#[cfg(test)]
mod tests {
    // Integration tests would require a real git repository
    // These would be in tests/ directory
}
```

## Desired State
Integration tests using temporary git repositories to verify range resolution.

## Acceptance Criteria
- [x] Test resolution of tag references (v1.0.0 → OID)
- [x] Test fallback to root commit when no tags exist
- [x] Test handling of invalid/nonexistent references
- [x] Test HEAD as default "to" reference
- [x] Test explicit from/to references
- [x] Test reference resolution (branches, tags, commit SHAs)

## Technical Notes
**File:** `src/git/range.rs:22-49`

Testing approach:
1. Use `tempfile` to create temp directories
2. Use `git2` to programmatically create test repos with:
   - Multiple commits
   - Tags (both lightweight and annotated)
   - Branches
3. Verify `resolve_range` returns correct OIDs

Test scenarios:
- Repo with multiple tags → latest tag used
- Repo with no tags → root commit used
- Explicit range specified → exact OIDs returned
- Invalid reference → error returned

---

## Resolution

**Completed:** 2026-01-25

### Approach
Created a `TestRepo` helper struct in `tests/common/mod.rs` that allows programmatic creation of git repositories with commits, tags (lightweight and annotated), and branches. Used this helper to write 13 comprehensive integration tests covering all acceptance criteria.

### Changes Made
- `tests/common/mod.rs`: Added `TestRepo` struct with methods for creating temp repos, commits, tags, and branches
- `tests/range_test.rs`: Added 13 integration tests for `resolve_range` function

### Test Coverage
| Test | Acceptance Criteria |
|------|---------------------|
| `test_resolve_range_with_lightweight_tag` | Tag references |
| `test_resolve_range_with_annotated_tag` | Tag references |
| `test_resolve_range_selects_latest_semver_tag` | Tag references |
| `test_resolve_range_fallback_to_root_commit` | Root commit fallback |
| `test_resolve_range_invalid_from_reference` | Invalid references |
| `test_resolve_range_invalid_to_reference` | Invalid references |
| `test_resolve_range_head_as_default_to` | HEAD default |
| `test_resolve_range_with_explicit_from_to` | Explicit from/to |
| `test_resolve_range_with_tag_reference` | Tag resolution |
| `test_resolve_range_with_branch_reference` | Branch resolution |
| `test_resolve_range_with_short_sha` | SHA resolution |
| `test_resolve_range_ignores_non_semver_tags` | Semver filtering |
| `test_resolve_range_mixed_semver_and_non_semver_tags` | Semver filtering |

### Testing
- [x] Build passes (`cargo build`)
- [x] All 88 tests pass (`cargo test`)
- [x] New range tests: 13 passing

---
*Solved by Claude Code*
