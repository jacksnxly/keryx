---
id: "KRX-030"
title: "Use lazy static for regex compilation in parse_commit_message"
type: improvement
status: in-review
priority: medium
labels: ["performance", "code-quality"]
created: "2026-01-26"
updated: "2026-01-26"
assignee: null
---

# Use lazy static for regex compilation in parse_commit_message

## Context
The regex pattern for parsing conventional commits is recompiled on every call to `parse_commit_message()`. While this may not be a significant performance issue for small repos, it's inefficient and a code smell.

## Current Implementation
In `src/git/commits.rs:97-99`:

```rust
pub fn parse_commit_message(message: &str) -> (Option<CommitType>, Option<String>, bool) {
    // ...
    let re_pattern = r"^(\w+)(?:\(([^)]+)\))?(!)?\s*:\s*";
    let re = regex_lite::Regex::new(re_pattern).unwrap();  // Compiled every call
```

## Proposed Improvement
Use `once_cell::sync::Lazy` (or `std::sync::LazyLock` in Rust 1.80+) to compile the regex once at startup.

## Acceptance Criteria
- [x] Regex is compiled only once
- [x] Performance is improved for large repos
- [x] All existing tests still pass

## Technical Notes
**File:** `src/git/commits.rs:97-99`

Suggested fix:
```rust
use once_cell::sync::Lazy;

static COMMIT_REGEX: Lazy<regex_lite::Regex> = Lazy::new(|| {
    regex_lite::Regex::new(r"^(\w+)(?:\(([^)]+)\))?(!)?\s*:\s*")
        .expect("Invalid commit regex pattern - this is a bug")
});

pub fn parse_commit_message(message: &str) -> (Option<CommitType>, Option<String>, bool) {
    // ...
    if let Some(caps) = COMMIT_REGEX.captures(first_line) {
        // ...
    }
}
```

Note: `once_cell` is already a dependency via other crates.

---

## Resolution

**Completed:** 2026-01-26

### Approach
Used `std::sync::LazyLock` from the Rust standard library (available since Rust 1.80) instead of adding `once_cell` dependency. This compiles the regex once on first use and reuses it for all subsequent calls.

### Changes Made
- `src/git/commits.rs:4`: Added `use std::sync::LazyLock;`
- `src/git/commits.rs:13-16`: Added `COMMIT_REGEX` static with `LazyLock` initialization
- `src/git/commits.rs:99`: Removed inline regex compilation, now uses `COMMIT_REGEX.captures()`

### Build Status
- [x] Build passes (`cargo check`, `cargo build --release`)
- [x] All 146 tests pass
- [x] No new dependencies added (uses std library)

---
*Solved by Claude Code*
