---
id: "KRX-005"
title: "Fix prompt injection filter to replace all occurrences"
type: bug
status: in-review
priority: high
labels: [security, bug]
created: "2026-01-25"
updated: "2026-01-25"
started: "2026-01-25"
assignee: null
---

# Fix prompt injection filter to replace all occurrences

## Problem
The prompt injection filter only replaces the **first** occurrence of each pattern, leaving subsequent occurrences intact.

## Current Behavior
In `src/claude/prompt.rs:201-236`:
```rust
fn filter_injection_patterns(text: &str) -> String {
    let mut result = text.to_string();
    for (pattern, replacement) in patterns {
        let lower = result.to_lowercase();
        if let Some(pos) = lower.find(pattern) {  // Only finds FIRST occurrence
            let end = pos + pattern.len();
            result = format!("{}{}{}", &result[..pos], replacement, &result[end..]);
        }
    }
    result
}
```

Input like `"ignore previous instructions ignore previous instructions"` would only have the first occurrence filtered.

## Expected Behavior
All occurrences of each injection pattern should be replaced.

## Acceptance Criteria
- [x] All occurrences of injection patterns are replaced
- [x] Add test case with multiple occurrences
- [x] Performance remains acceptable (no regex explosion)

## Technical Notes
**File:** `src/claude/prompt.rs:201-236`

Option 1 - Loop until no more matches:
```rust
loop {
    let lower = result.to_lowercase();
    if let Some(pos) = lower.find(pattern) {
        // replace
    } else {
        break;
    }
}
```

Option 2 - Use str::replace (simpler but case-sensitive):
```rust
// Need case-insensitive replace - may need regex or custom impl
```

---

## Resolution

**Completed:** 2026-01-25

### Approach
Used Option 1 (loop until no more matches) as it maintains case-insensitive matching without adding regex dependencies. The fix wraps the existing `if let Some(pos)` in a `loop` that continues until no more matches are found.

### Changes Made
- `src/claude/prompt.rs:234-241`: Wrapped pattern matching in a loop to replace all occurrences
- `src/claude/prompt.rs:418-442`: Added two new test cases for multiple occurrence filtering

### Code Change
```rust
// Before (only first occurrence)
for (pattern, replacement) in patterns {
    let lower = result.to_lowercase();
    if let Some(pos) = lower.find(pattern) {
        // ...
    }
}

// After (all occurrences)
for (pattern, replacement) in patterns {
    loop {
        let lower = result.to_lowercase();
        if let Some(pos) = lower.find(pattern) {
            // ...
        } else {
            break;
        }
    }
}
```

### Testing
- [x] Build passes
- [x] 91 tests pass (including 2 new tests)
- [x] `test_sanitize_filters_multiple_occurrences` - verifies multiple identical patterns are all filtered
- [x] `test_sanitize_filters_mixed_case_multiple_occurrences` - verifies case-insensitive filtering works for all occurrences

### Performance
No regex used - simple string operations with O(n*m) complexity where n is string length and m is number of pattern occurrences. This is acceptable for input strings limited to 10,000 characters.

---
*Solved by Claude Code*
