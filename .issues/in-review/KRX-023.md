---
id: "KRX-023"
title: "Fix JSON serialization fallback to empty string in prompt builder"
type: bug
status: in-review
priority: urgent
labels: ["silent-failure", "error-handling", "critical-gap"]
created: "2026-01-26"
updated: "2026-01-26"
assignee: null
---

# Fix JSON serialization fallback to empty string in prompt builder

## Problem
If JSON serialization fails during prompt building, the code logs an error but continues with an empty string. This sends a malformed prompt to Claude, resulting in meaningless changelog output.

## Current Behavior
In `src/claude/prompt.rs:40-47`:

```rust
let commits_json = serde_json::to_string_pretty(&sanitized_commits).unwrap_or_else(|e| {
    error!("Failed to serialize commits for prompt: {}", e);
    String::new()  // Continues with empty string!
});
```

## Expected Behavior
JSON serialization failure should be a hard error that stops execution, not a silent fallback that produces garbage output.

## Steps to Reproduce
1. Trigger a serialization failure (e.g., by having commits with invalid data)
2. Observe that the prompt is sent with empty commit/PR sections
3. Claude generates meaningless changelog

**Environment:** All platforms

## Acceptance Criteria
- [x] JSON serialization failure returns an error instead of falling back
- [x] User sees clear error message about serialization failure
- [x] No malformed prompts are sent to Claude

## Technical Notes
**File:** `src/claude/prompt.rs:40-47`

Suggested fix: Return a `Result` from `build_prompt()` instead of using `unwrap_or_else`:
```rust
let commits_json = serde_json::to_string_pretty(&sanitized_commits)
    .map_err(|e| ClaudeError::SerializationFailed(e.to_string()))?;
```

This may require changing the function signature to return `Result<String, ClaudeError>`.

---

## Resolution

**Completed:** 2026-01-26

### Approach
Changed `build_prompt()` to return `Result<String, ClaudeError>` instead of `String`, propagating serialization errors instead of silently falling back to empty strings.

### Changes Made
- `src/error.rs`: Added `SerializationFailed(String)` variant to `ClaudeError` enum
- `src/claude/prompt.rs`: Changed `build_prompt()` signature to return `Result<String, ClaudeError>`, replaced `unwrap_or_else` with proper error propagation using `?`
- `src/main.rs`: Updated caller to handle the `Result` with `.context()`

### Testing
- [x] Build passes (`cargo check`)
- [x] All 146 tests pass (`cargo test`)
- [x] Clippy passes

---
*Solved by Claude Code*
