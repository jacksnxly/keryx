---
id: "KRX-064"
title: "Fix overly broad error handling in check_ripgrep_installed"
type: bug
status: done
priority: urgent
labels: ["error-handling", "silent-failure", "critical-gap"]
created: "2026-01-27"
updated: "2026-01-27"
started: "2026-01-27"
assignee: null
---

# Fix overly broad error handling in check_ripgrep_installed

## Problem
The `check_ripgrep_installed` function uses a wildcard `_` pattern that converts all error types to `RipgrepNotInstalled`. This conflates "not installed" with "installed but broken" or "permission denied", giving users incorrect remediation advice.

## Current Behavior
Any failure when running `rg --version` results in "ripgrep is not installed" error, suggesting users install ripgrep even when:
- ripgrep exists but has permission denied
- ripgrep is corrupted
- ripgrep has missing shared library dependencies
- ripgrep times out

## Expected Behavior
Handle specific error cases:
- `NotFound` → `RipgrepNotInstalled` (install suggestion appropriate)
- Execution errors → `RipgrepExecutionFailed` with actual error details
- Non-zero exit → `RipgrepFailed` with exit code and stderr

## Steps to Reproduce
1. Create a `rg` script that exits with code 1 (or set permissions to 000)
2. Run keryx with verification enabled
3. Observe "ripgrep not installed" error despite it being present

**Environment:** Any environment where `rg` exists but fails for non-installation reasons

## Acceptance Criteria
- [x] `NotFound` error correctly maps to "not installed" message
- [x] Permission denied errors show appropriate message
- [x] Exit code failures show the actual exit code and stderr
- [x] Error messages guide users to correct remediation

## Technical Notes
**Location:** `src/verification/mod.rs:20-28`

```rust
// Current problematic code:
match output {
    Ok(out) if out.status.success() => Ok(()),
    _ => Err(VerificationError::RipgrepNotInstalled),  // TOO BROAD
}

// Recommended fix:
match output {
    Ok(out) if out.status.success() => Ok(()),
    Ok(out) => Err(VerificationError::RipgrepFailed {
        exit_code: out.status.code(),
        stderr: String::from_utf8_lossy(&out.stderr).to_string()
    }),
    Err(e) if e.kind() == std::io::ErrorKind::NotFound =>
        Err(VerificationError::RipgrepNotInstalled),
    Err(e) => Err(VerificationError::RipgrepExecutionFailed(e.to_string())),
}
```

May require adding new variants to `VerificationError` enum in `src/error.rs`.

---

## Resolution

**Completed:** 2026-01-27

### Approach
Replaced the wildcard `_` catch-all match arm with three specific arms that distinguish between: (1) ripgrep not found on PATH (`NotFound` IO error), (2) ripgrep found but exited with non-zero status, and (3) ripgrep found but failed to execute for other reasons (e.g., permission denied, corrupted binary).

### Changes Made
- `src/error.rs`: Added `RipgrepFailed { exit_code, stderr }` and `RipgrepExecutionFailed(String)` variants to `VerificationError` enum with descriptive error messages and remediation guidance
- `src/verification/mod.rs`: Replaced wildcard `_` pattern with specific match arms for `Ok(out)` (non-zero exit), `Err(NotFound)`, and `Err(other)`

### Testing
- [x] Build passes (`cargo build`)
- [x] All 159 tests pass (`cargo test`)
- [ ] Manual testing required

---
*Solved by Claude Code*
