---
id: "KRX-008"
title: "Add tests for GitHub PR fetching with mocked octocrab"
type: task
status: done
priority: high
labels: [testing, critical-gap]
created: "2026-01-25"
updated: "2026-01-25"
assignee: jacksnxly
---

# Add tests for GitHub PR fetching with mocked octocrab

## Context
The `fetch_merged_prs` function in `src/github/prs.rs` is completely untested. This is critical business logic that handles pagination, rate limiting, repository errors, and date filtering.

## Current State
Zero tests for the entire GitHub PR fetching module. The file notes in comments that tests are needed.

## Desired State
Comprehensive test coverage using mocked octocrab responses.

## Acceptance Criteria
- [x] Test pagination handling (multi-page responses)
- [x] Test date filtering with various since/until combinations
- [x] Test PR body truncation at exactly 10KB boundary
- [x] Test rate limit error detection
- [x] Test repository not found error detection
- [x] Test 50-page safety limit logging

## Technical Notes
**File:** `src/github/prs.rs:25-137`

Testing approach:
1. Use `mockito` or similar to mock HTTP responses
2. Or create a trait abstraction over octocrab for testability
3. Test fixtures should include multi-page scenarios

Key functions to test:
- `fetch_merged_prs` (main function)
- Date filtering logic (lines 86-96)
- Body truncation (lines 99-105)
- Pagination safety limit (lines 130-133)

---

## Resolution

**Completed:** 2026-01-25

### Approach
Used `wiremock` HTTP mocking library with `OctocrabBuilder::base_uri()` to redirect API calls to a mock server. This approach:
- Required minimal production code changes
- Supports parallel test execution with isolated mock servers per test
- Provides fine-grained control over response simulation

### Changes Made

**Production Code:**
- `Cargo.toml`: Added `wiremock = "0.6"` dev dependency
- `src/github/prs.rs`:
  - Refactored to add `fetch_merged_prs_with_client()` function accepting `&Octocrab` for dependency injection
  - Added `tracing::warn` import for safety limit logging
  - Improved error detection to check both Display and Debug output for rate limit/404 errors
- `src/github/mod.rs`: Exported `fetch_merged_prs_with_client` for test access

**Test Code:**
- `tests/github_prs_test.rs`: New test file with 16 comprehensive tests
- `tests/common/mod.rs`: Added `github_fixture()` helper function (unused but available)

### Test Coverage

| Category | Tests | Status |
|----------|-------|--------|
| Pagination | `test_pagination_single_page`, `test_pagination_multiple_pages`, `test_empty_repository` | ✓ Pass |
| Date Filtering | `test_filter_since_date`, `test_filter_until_date`, `test_filter_date_range`, `test_filter_excludes_all` | ✓ Pass |
| Body Truncation | `test_body_at_limit_not_truncated`, `test_body_over_limit_truncated`, `test_pr_with_no_body` | ✓ Pass |
| Error Handling | `test_rate_limit_error`, `test_repository_not_found` | ✓ Pass |
| Safety Limit | `test_safety_limit_50_pages` | ✓ Pass |
| Edge Cases | `test_filters_unmerged_prs`, `test_pr_with_labels`, `test_pr_with_no_labels` | ✓ Pass |

**Total: 16 new tests, all passing**

### Research Sources
- [wiremock-rs documentation](https://docs.rs/wiremock/latest/wiremock/)
- [octocrab documentation](https://docs.rs/octocrab/latest/octocrab/)
- [GitHub REST API documentation](https://docs.github.com/en/rest/pulls/pulls)

### Testing
- [x] Build passes (`cargo build --release`)
- [x] All 91 tests pass (`cargo test`)
- [x] No new clippy warnings

---
*Solved by Claude Code*
