---
id: "KRX-081"
title: "Extract run_rg helper to eliminate 6x duplicated ripgrep output handling"
type: improvement
status: in-review
priority: high
labels: ["code-quality"]
created: "2026-01-27"
updated: "2026-01-28"
assignee: null
---

# Extract run_rg helper to eliminate 6x duplicated ripgrep output handling

## Context
The same `match output { Ok(out) if ... }` pattern for handling ripgrep's `Output` appears 6 times across `search_keyword`, `find_stub_indicators_near_keyword`, and `search_and_count_array`. Each repeats the same three-arm logic: success, exit code 1 (no matches), error/NotFound.

## Current Implementation
Each call site has ~15 lines of identical match logic handling ripgrep subprocess output. Total duplication: ~80-100 lines in scanner.rs.

## Proposed Improvement
Extract a `run_rg` helper:
```rust
enum RgOutcome { Success(String), NoMatch }

fn run_rg(cmd: &mut Command, context: &str) -> Result<RgOutcome, ScannerError> { ... }
```

Each call site becomes ~2 lines instead of ~15. Also add `run_rg_or_warn` variant for functions that log and return defaults.

## Acceptance Criteria
- [x] Single `run_rg` helper handles ripgrep output categorization
- [x] All 6 ripgrep output match blocks refactored to use the helper
- [x] `run_rg_or_warn` variant for best-effort callers
- [x] scanner.rs reduced by ~80-100 lines
- [x] All existing tests pass

## Technical Notes
- **File:** `src/verification/scanner.rs`
- Affected functions: `search_keyword` (3 match blocks), `find_stub_indicators_near_keyword` (2 match blocks), `search_and_count_array` (1 match block)
- Also consider extracting the duplicated PR fetch error handling in `main.rs` (3 identical blocks)

---

## Resolution

**Completed:** 2026-01-28

### Approach
Extracted two helper functions to centralize ripgrep output handling:
1. `RgOutcome` enum with `Success(String)` and `NoMatch` variants
2. `run_rg(cmd)` - Returns `Result<RgOutcome, VerificationError>` for critical calls
3. `run_rg_or_warn(cmd, context)` - Returns `Option<String>` for best-effort calls, logs warnings on failure

### Changes Made
- `src/verification/scanner.rs`:
  - Added `RgOutcome` enum (lines 18-23)
  - Added `run_rg` function (lines 25-46) for critical ripgrep calls
  - Added `run_rg_or_warn` function (lines 48-58) for best-effort calls
  - Refactored `search_keyword` from ~60 lines of match logic to ~15 lines
  - Refactored `find_stub_indicators_near_keyword` from ~50 lines to ~25 lines
  - Refactored `search_and_count_array` from ~35 lines to ~10 lines

### Metrics
- **Net reduction:** 83 lines (249 removed, 166 added)
- **File size:** 1259 lines -> 1149 lines (8.7% reduction)
- **Match blocks eliminated:** 6 duplicated patterns -> 0

### Testing
- [x] Build passes (`cargo build`)
- [x] All 169 unit tests pass (`cargo test`)
- [x] All 14 integration tests pass

---
*Solved by Claude Code*
