---
id: "KRX-002"
title: "Add logging for JSON serialization fallback in prompt building"
type: bug
status: done
priority: high
labels: [error-handling, silent-failure]
created: "2026-01-25"
updated: "2026-01-25"
assignee: null
---

# Add logging for JSON serialization fallback in prompt building

## Problem
JSON serialization failures silently fall back to empty strings, causing Claude to receive incomplete prompts without any warning.

## Current Behavior
In `src/claude/prompt.rs:39-40`:
```rust
let commits_json = serde_json::to_string_pretty(&sanitized_commits).unwrap_or_default();
let prs_json = serde_json::to_string_pretty(&sanitized_prs).unwrap_or_default();
```
If serialization fails, empty strings are used silently.

## Expected Behavior
Serialization failures should be logged so users know their data was lost from the prompt.

## Acceptance Criteria
- [x] Serialization errors are logged at error level
- [x] Log message indicates which data (commits or PRs) failed
- [x] Operation continues with warning (current fallback behavior preserved)

## Technical Notes
**File:** `src/claude/prompt.rs:39-40`

Option 1 - Log and continue:
```rust
let commits_json = serde_json::to_string_pretty(&sanitized_commits)
    .unwrap_or_else(|e| {
        tracing::error!("Failed to serialize commits: {}", e);
        String::new()
    });
```

Option 2 - Propagate error (breaking change):
```rust
let commits_json = serde_json::to_string_pretty(&sanitized_commits)
    .map_err(|e| ClaudeError::SerializationFailed(e.to_string()))?;
```

---

## Resolution

**Completed:** 2026-01-25

### Approach
Implemented Option 1 (log and continue) as specified in the issue. Added `tracing::error!` macros to log serialization failures while preserving the existing fallback behavior that returns an empty string.

### Changes Made
- `src/claude/prompt.rs:5`: Added `use tracing::error;` import
- `src/claude/prompt.rs:42-48`: Replaced `unwrap_or_default()` with `unwrap_or_else()` closure that logs errors at error level before returning empty string

### Build Status
- [x] Build passes (`cargo build`)
- [x] All 89 tests pass (`cargo test`)
- [ ] Manual testing required

---
*Solved by Claude Code*
