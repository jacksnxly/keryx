---
id: "KRX-073"
title: "Fix stub detection failure silently marking features as complete"
type: bug
status: in-review
priority: urgent
labels: ["bug", "silent-failure", "critical-gap"]
created: "2026-01-27"
updated: "2026-01-27"
resolved: "2026-01-27"
assignee: null
---

# Fix stub detection failure silently marking features as complete

## Problem
`find_stub_indicators_near_keyword` returns an empty `Vec<StubIndicator>` on all error paths (ripgrep failure, I/O errors, permission issues). The caller treats an empty result as "no stubs found" and sets `appears_complete = true`. This means if ripgrep fails during stub detection, incomplete code full of TODOs and `unimplemented!()` is marked as "verified complete."

This is the exact opposite of what the verification system promises: when verification cannot determine the truth, it defaults to "everything is fine" instead of "we don't know."

## Current Behavior
Any error in `find_stub_indicators_near_keyword` (scanner.rs:358-391) silently returns `Vec::new()`, causing:
- `stubs.is_empty()` = `true`
- `appears_complete` = `true` (if count also succeeded)
- Feature appears fully implemented when it may not be

## Expected Behavior
When stub detection fails, the system should conservatively assume the feature may be incomplete (`appears_complete = false`), and log a warning indicating that completeness could not be verified.

## Acceptance Criteria
- [x] `find_stub_indicators_near_keyword` returns `Result<Vec<StubIndicator>, ScannerError>`
- [x] Caller sets `appears_complete = false` when stub detection errors
- [x] Warning logged when stub detection fails for a keyword
- [x] Existing integration tests continue to pass

## Technical Notes
- **File:** `src/verification/scanner.rs:358-391` (function), `src/verification/scanner.rs:106-108` (caller)
- The same philosophical issue exists in `CountCheck::matches()` -- see KRX-074
- This is part of a broader pattern: the verification system favors "never block the user" over "catch problems," undermining its core purpose

---

## Resolution

**Completed:** 2026-01-27

### Approach
Changed `find_stub_indicators_near_keyword` from returning `Vec<StubIndicator>` to `Result<Vec<StubIndicator>, ScannerError>`. Error paths now propagate typed errors to the caller instead of silently returning empty vectors. The caller in `analyze_entry` matches on the Result and conservatively sets `appears_complete = false` when stub detection fails, with a warning log.

### Changes Made
- `src/verification/scanner.rs:345-461`: Changed function signature to return `Result<Vec<StubIndicator>, ScannerError>`. Replaced silent `return indicators` on error paths with `return Err(ScannerError::RipgrepFailed { .. })`, `Err(ScannerError::RipgrepNotFound)`, and `Err(ScannerError::IoError(..))`.
- `src/verification/scanner.rs:102-127`: Updated caller to match on `Result`. On `Err`, logs a warning and sets `stub_detection_ok = false`, which feeds into `appears_complete = stub_detection_ok && stubs.is_empty() && match_result.count.is_some()`.

### Testing
- [x] Build passes (`cargo build`)
- [x] All 172 tests pass (`cargo test`)
- [ ] Manual testing required

---
*Solved by Claude Code*
