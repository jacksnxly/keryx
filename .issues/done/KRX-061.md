# [KRX-061] Add integration test for verification flow

**Type:** task
**Priority:** medium
**Status:** done
**Labels:** testing, critical-gap
**Created:** 2026-01-27
**Updated:** 2026-01-27
**Branch:** feat/agentic-verification

---

## Problem

The `verify_changelog_entries()` function in `main.rs` is the primary entry point for verification, but it has no integration test. This function orchestrates:
1. `gather_verification_evidence()` - scans codebase
2. `build_verification_prompt()` - creates Claude prompt
3. Claude API call for verification
4. Returns corrected entries

If this flow breaks, users will see verification failures or silent hallucination pass-through.

## Current Test Coverage

The individual components have unit tests:
- `build_verification_prompt` - 6 tests
- `VerificationEvidence` methods - 9 tests
- `verify_numeric_claims` - 8 tests
- `parse_rg_line` - 6 tests

But the end-to-end flow is untested.

## Acceptance Criteria

- [x] Integration test creates temp repo with known code
- [x] Test creates mock changelog entries (some accurate, some inaccurate)
- [x] Test runs `gather_verification_evidence` against temp repo
- [x] Test verifies evidence correctly identifies issues:
  - Keywords found in expected files
  - Stub indicators detected for incomplete code
  - Count mismatches flagged
  - Confidence levels computed correctly
- [x] Test can run without Claude API (tests evidence gathering, not Claude response)

## Technical Notes

**Location:** Create `tests/verification_integration_test.rs`

**Approach:**
Since testing the full flow requires Claude API, focus on testing the evidence gathering:

```rust
#[test]
fn test_verification_evidence_gathering() {
    let temp_dir = tempfile::tempdir().unwrap();

    // Create test files with known content
    std::fs::write(
        temp_dir.path().join("src/feature.rs"),
        r#"
        pub fn websocket_connect() {
            // TODO: implement this
            unimplemented!()
        }
        "#
    ).unwrap();

    // Create mock changelog entries
    let entries = vec![
        ChangelogEntry {
            category: "Added".to_string(),
            description: "WebSocket support for real-time updates".to_string(),
        }
    ];

    // Gather evidence
    let evidence = gather_verification_evidence(&entries, temp_dir.path());

    // Verify evidence correctly identifies issues
    assert!(!evidence.entries.is_empty());
    let entry_ev = &evidence.entries[0];

    // Should find keyword
    assert!(entry_ev.keyword_matches.iter().any(|k| k.keyword == "websocket"));

    // Should detect stub indicators
    assert!(!entry_ev.stub_indicators.is_empty());

    // Confidence should be low due to TODO/unimplemented
    assert_eq!(entry_ev.confidence, Confidence::Low);
}
```

**Note:** This test requires `rg` to be installed. Add a skip condition for CI environments without ripgrep.

---
*Created from PR review of feat/agentic-verification*

---

## Resolution

**Completed:** 2026-01-27

### Approach

Created comprehensive integration tests for the verification evidence gathering system. Tests verify keyword matching, stub indicator detection, confidence level computation, and key file gathering against a temporary test project with known code patterns.

### Changes Made

- `tests/verification_integration_test.rs`: Created with 14 integration tests covering:
  - Keyword search (WebSocket, Postgres, missing features)
  - Stub indicator detection (TODO, FIXME, unimplemented!, todo!)
  - Confidence level computation (high/low based on evidence)
  - Key files gathering (Cargo.toml)
  - Multiple entries analysis
  - Edge cases (empty entries, no extractable keywords)

- `src/verification/mod.rs`: Added `StubIndicator` to public exports for integration tests

### Test Coverage

| Test Category | Tests |
|---------------|-------|
| Keyword search | 3 |
| Stub indicators | 2 |
| Confidence levels | 3 |
| Key files | 1 |
| Multiple entries | 1 |
| Low confidence detection | 1 |
| Edge cases | 3 |
| **Total** | **14** |

### Research Sources

- [Rust Book: Test Organization](https://doc.rust-lang.org/book/ch11-03-test-organization.html)
- [tempfile crate documentation](https://docs.rs/tempfile/)
- Existing test patterns in `tests/common/mod.rs`

### Testing

- [x] Build passes (`cargo build`)
- [x] All 14 new integration tests pass
- [x] All 154 existing unit tests pass
- [x] All existing integration tests pass (168 tests total)
- [x] Tests skip gracefully when `rg` is not installed

---
*Solved by Claude Code*
