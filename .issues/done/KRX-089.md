---
id: "KRX-089"
title: "Fix PR body truncation panic on multi-byte UTF-8"
type: bug
status: in-review
priority: high
labels: ["critical-gap", "bug"]
created: "2026-02-02"
updated: "2026-02-02"
assignee: null
---

# Fix PR body truncation panic on multi-byte UTF-8

## Problem
In `src/version/llm_bump.rs:55`, the PR body is truncated using byte slicing:
```rust
let truncated = if b.len() > 500 { &b[..500] } else { b };
```

If byte position 500 falls in the middle of a multi-byte UTF-8 character (emoji, CJK, accented characters), Rust panics at runtime with "byte index 500 is not a char boundary."

## Current Behavior
Runtime panic when a PR body contains multi-byte characters around the 500-byte boundary.

## Expected Behavior
Truncation respects UTF-8 character boundaries, using the same `is_char_boundary` pattern already used elsewhere in the codebase.

## Steps to Reproduce
1. Create a PR with a body containing multi-byte characters (e.g., emoji) such that the 500th byte falls mid-character
2. Run `keryx generate`
3. Program panics

## Acceptance Criteria
- [ ] PR body truncation uses `is_char_boundary` loop (matching `sanitize_for_prompt` and `truncate_description` patterns)
- [ ] Unit test with a PR body containing multi-byte characters at the truncation boundary
- [ ] No panics on any valid UTF-8 input

## Technical Notes
- File: `src/version/llm_bump.rs:55`
- Existing correct patterns:
  - `sanitize_for_prompt` in `src/llm/prompt.rs:233-239`
  - `truncate_description` in `src/main.rs:1082-1092`
- Same class of bug as KRX-079 which was already fixed for `sanitize_for_prompt`
- Flagged by: code-reviewer, test-analyzer, type-design-analyzer

---

## Resolution

**Completed:** 2026-02-02

### Approach
Replaced unsafe byte-slice `&b[..500]` with a `is_char_boundary` loop that walks backwards from position 500 to find a valid UTF-8 boundary. This matches the existing patterns in `sanitize_for_prompt` and `truncate_description`.

### Changes Made
- `src/version/llm_bump.rs`: Replaced `&b[..500]` with `is_char_boundary` loop for safe UTF-8 truncation
- `src/version/llm_bump.rs`: Added `test_build_prompt_pr_body_multibyte_utf8_truncation` test (emoji at boundary)
- `src/version/llm_bump.rs`: Added `test_build_prompt_pr_body_cjk_truncation` test (CJK chars at boundary)

### Testing
- [x] Build passes
- [x] Type checks pass
- [x] All 14 llm_bump unit tests pass (including 2 new)
- [x] Tests cover emoji (4-byte) and CJK (3-byte) multi-byte characters at the truncation boundary

---
*Solved by Claude Code*
