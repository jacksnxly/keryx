---
id: "KRX-069"
title: "Convert skip_without_rg pattern to proper test ignore attributes"
type: improvement
status: done
priority: high
labels: ["testing", "critical-gap"]
created: "2026-01-27"
updated: "2026-01-27"
assignee: null
---

# Convert skip_without_rg pattern to proper test ignore attributes

## Context
Integration tests use a `skip_without_rg()` pattern that silently passes tests when ripgrep is not installed. In CI environments without rg, all 14 integration tests show as "passed" but actually did nothing.

## Current State
```rust
fn skip_without_rg() -> bool {
    if check_ripgrep_installed().is_err() {
        eprintln!("Skipping test: ripgrep (rg) not found in PATH");
        true
    } else {
        false
    }
}

#[test]
fn test_keyword_search_finds_websocket() {
    if skip_without_rg() { return; }
    // actual test
}
```

This results in false positives in CI - tests pass without running.

## Desired State
Use Rust's built-in test ignore mechanisms:
```rust
#[test]
#[cfg_attr(not(feature = "rg-tests"), ignore = "requires ripgrep")]
fn test_keyword_search_finds_websocket() {
    // actual test
}
```

Or fail CI explicitly if ripgrep is required.

## Acceptance Criteria
- [x] Tests that require ripgrep use `#[ignore]` attribute when rg unavailable
- [x] CI configuration ensures ripgrep is installed or tests are explicitly skipped
- [x] Test output clearly shows which tests were skipped vs passed

## Technical Notes
**Location:** `tests/verification_integration_test.rs`

Options:
1. Add `rg-tests` feature flag, use `#[cfg_attr(not(feature = "rg-tests"), ignore)]`
2. Use `#[ignore]` and run with `--include-ignored` in CI where rg is available
3. Add ripgrep to CI environment (preferred for verification tests)

---

## Resolution

**Completed:** 2026-01-27

### Approach
Used Option 1 from the technical notes: added an `rg-tests` feature flag and replaced all `skip_without_rg()` runtime checks with compile-time `#[cfg_attr(not(feature = "rg-tests"), ignore = "requires ripgrep")]` attributes.

### Changes Made
- `Cargo.toml`: Added `[features]` section with `rg-tests` feature flag
- `tests/verification_integration_test.rs`: Replaced `skip_without_rg()` pattern in all 14 tests with `#[cfg_attr]` ignore attribute; removed `skip_without_rg()` function and unused `check_ripgrep_installed` import

### Usage
- Default: `cargo test` — ripgrep tests show as "ignored, requires ripgrep"
- With rg: `cargo test --features rg-tests` — all 14 tests run normally

### Testing
- [x] Build passes
- [x] 14 tests correctly ignored without feature flag
- [x] 14 tests pass with `--features rg-tests`
- [x] Full test suite (285 tests) passes with no regressions

---
*Solved by Claude Code*
