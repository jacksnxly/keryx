# [KRX-056] Make CountCheck.matches a computed method instead of stored field

**Type:** improvement
**Priority:** medium
**Status:** done
**Labels:** code-quality
**Created:** 2026-01-26
**Branch:** feat/agentic-verification

---

## Problem

The `CountCheck` struct has a `matches` field that can be set to contradict the count fields. This allows invalid states like:

```rust
CountCheck {
    claimed_count: Some(5),
    actual_count: Some(3),
    matches: true,  // Logically impossible!
}
```

## Current Design

```rust
// src/verification/evidence.rs
pub struct CountCheck {
    pub claimed_text: String,
    pub claimed_count: Option<usize>,
    pub actual_count: Option<usize>,
    pub source_location: Option<String>,
    pub matches: bool,  // Stored, can be inconsistent
}
```

## Expected Design

`matches` should be computed from the counts, not stored separately:

```rust
pub struct CountCheck {
    pub claimed_text: String,
    pub claimed_count: Option<usize>,
    pub actual_count: Option<usize>,
    pub source_location: Option<String>,
    // No `matches` field - computed instead
}

impl CountCheck {
    /// Returns true if counts match or if actual_count is unknown.
    pub fn matches(&self) -> bool {
        match (self.claimed_count, self.actual_count) {
            (Some(claimed), Some(actual)) => claimed == actual,
            _ => true,  // Unknown actual count = assume match
        }
    }
}
```

## Acceptance Criteria

- [x] Remove `matches` field from `CountCheck` struct
- [x] Add `matches()` method that computes from counts
- [x] Update serialization to include computed `matches` in output (for Claude prompt)
- [x] Update all usages in `scanner.rs` and `main.rs`
- [x] Impossible to create logically inconsistent `CountCheck`

## Technical Notes

**Affected files:**
- `src/verification/evidence.rs` - struct definition
- `src/verification/scanner.rs:372-383` - where `CountCheck` is created
- `src/verification/scanner.rs:596-598` - where `matches` is read
- `src/main.rs:868-871` - where `matches` is checked

**Serde consideration:**
To include `matches` in JSON serialization while keeping it computed:
```rust
impl Serialize for CountCheck {
    fn serialize<S>(&self, serializer: S) -> Result<S::Ok, S::Error> {
        // Include computed `matches` in output
    }
}
```

Or use `#[serde(serialize_with = "...")]` on a wrapper.

---

## Resolution

**Completed:** 2026-01-27

### Approach

Converted `matches` from a stored field to a computed method. Used a custom `Serialize` implementation to ensure JSON output still includes the `matches` field for Claude's verification prompt.

### Changes Made

- `src/verification/evidence.rs`:
  - Removed `matches: bool` field from `CountCheck` struct
  - Added `matches()` method that computes from `claimed_count` and `actual_count`
  - Added custom `Serialize` impl to include computed `matches` in JSON output
  - Added 7 unit tests for `matches()` logic and serialization

- `src/verification/scanner.rs`:
  - Removed `matches` variable computation (line ~480)
  - Removed `matches` field from struct initialization
  - Changed `check.matches` to `check.matches()` in confidence calculation

- `src/main.rs`:
  - Changed `check.matches` to `check.matches()` in count mismatch warning

- `src/claude/prompt.rs`:
  - Removed `matches: false` from test construction

### Testing

- [x] Build passes (cargo build --release)
- [x] All 253 tests pass (cargo test)
- [x] New unit tests verify `matches()` logic for all cases
- [x] Serialization test verifies JSON includes computed `matches`

---
*Solved by Claude Code*
