---
id: "KRX-024"
title: "Add warning when KERYX_CLAUDE_TIMEOUT env var is invalid"
type: improvement
status: done
priority: high
labels: ["error-handling", "ux"]
created: "2026-01-26"
updated: "2026-01-26"
resolved: "2026-01-26"
assignee: null
---

# Add warning when KERYX_CLAUDE_TIMEOUT env var is invalid

## Context
Users who set the `KERYX_CLAUDE_TIMEOUT` environment variable expect it to be used. When the value is invalid (non-numeric, negative, overflow), the code silently falls back to the default, leaving users unaware their configuration was ignored.

## Current Implementation
In `src/claude/subprocess.rs:22-28`:

```rust
fn get_timeout() -> Duration {
    env::var(TIMEOUT_ENV_VAR)
        .ok()
        .and_then(|v| v.parse::<u64>().ok())
        .map(Duration::from_secs)
        .unwrap_or_else(|| Duration::from_secs(DEFAULT_TIMEOUT_SECS))
}
```

All parse failures silently fall back to default.

## Proposed Improvement
Log a warning when the environment variable is present but contains an invalid value, so users know their configuration was not applied.

## Acceptance Criteria
- [x] Warning logged when env var is present but invalid
- [x] Warning includes the invalid value and the default being used
- [x] Valid values continue to work without warnings
- [x] Missing env var does not produce a warning

## Technical Notes
**File:** `src/claude/subprocess.rs:22-28`

Suggested fix:
```rust
fn get_timeout() -> Duration {
    match env::var(TIMEOUT_ENV_VAR) {
        Ok(v) if !v.is_empty() => {
            match v.parse::<u64>() {
                Ok(secs) => Duration::from_secs(secs),
                Err(_) => {
                    tracing::warn!(
                        "Invalid {} value '{}', using default {}s",
                        TIMEOUT_ENV_VAR, v, DEFAULT_TIMEOUT_SECS
                    );
                    Duration::from_secs(DEFAULT_TIMEOUT_SECS)
                }
            }
        }
        _ => Duration::from_secs(DEFAULT_TIMEOUT_SECS),
    }
}
```

---

## Resolution

**Completed:** 2026-01-26

### Approach
Implemented the suggested fix from the issue. Refactored `get_timeout()` to use a `match` statement that distinguishes between:
1. Valid env var values → parse and use
2. Invalid env var values (non-empty but unparseable) → warn and use default
3. Missing or empty env var → silently use default

### Changes Made
- `src/claude/subprocess.rs:10`: Added `use tracing::warn;` import
- `src/claude/subprocess.rs:23-38`: Refactored `get_timeout()` from a functional chain to a `match` statement that logs a warning when an invalid value is provided

### Testing
- [x] Build passes (`cargo build`)
- [x] All 152 tests pass (`cargo test`)
- [x] No clippy warnings (`cargo clippy`)
- [x] Existing timeout tests still pass (verify correct timeout values returned)

### Behavior Verification
| Input | Before | After |
|-------|--------|-------|
| Not set | Default (silent) | Default (silent) |
| Empty string "" | Default (silent) | Default (silent) |
| Valid "60" | 60 seconds | 60 seconds |
| Invalid "abc" | Default (silent) | Default + warning |
| Invalid "-5" | Default (silent) | Default + warning |

---
*Solved by Claude Code*
