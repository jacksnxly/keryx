# [KRX-057] Fix UTF-8 panic risk in gather_key_files string truncation

**Type:** bug
**Priority:** high
**Status:** done
**Labels:** bug, error-handling
**Created:** 2026-01-27
**Branch:** feat/agentic-verification

---

## Problem

The `gather_key_files` function in `scanner.rs` uses byte slicing `&content[..5000]` without checking for character boundaries. This can panic if a multi-byte UTF-8 character spans the 5000 byte boundary.

## Current Behavior

```rust
let truncated = if content.len() > 5000 {
    format!("{}...[truncated]", &content[..5000])  // May panic!
} else {
    content
};
```

If a key file (like README.md with non-ASCII content) has a multi-byte character at exactly byte 5000, the program will panic with a "byte index is not a char boundary" error.

## Expected Behavior

The truncation should respect UTF-8 character boundaries, similar to the fix applied in `truncate_description` (KRX-047).

## Acceptance Criteria

- [x] `gather_key_files` uses `is_char_boundary()` check before truncating
- [x] No panic when key files contain multi-byte characters at truncation point
- [x] Add test with non-ASCII content in key file

## Technical Notes

**Location:** `src/verification/scanner.rs:819-820`

**Fix:** Apply the same pattern used in `truncate_description`:
```rust
let truncated = if content.len() > 5000 {
    let mut end = 5000;
    while end > 0 && !content.is_char_boundary(end) {
        end -= 1;
    }
    format!("{}...[truncated]", &content[..end])
} else {
    content
};
```

---
*Created from PR review of feat/agentic-verification*

---

## Resolution

**Completed:** 2026-01-27

### Approach
Applied the same `is_char_boundary()` pattern already used elsewhere in the codebase (`truncate_description` in main.rs, PR body truncation in prs.rs, and prompt truncation in claude/prompt.rs).

### Changes Made
- `src/verification/scanner.rs`: Updated `gather_key_files` function to check UTF-8 character boundaries before truncating content, preventing panics when multi-byte characters span the 5000 byte boundary

### Tests Added
- `test_gather_key_files_truncates_large_files_with_utf8`: Creates a temp dir with README.md containing 6000+ bytes of CJK characters to verify truncation works without panicking
- `test_gather_key_files_does_not_truncate_small_files`: Verifies small files with UTF-8 content (including emojis) are returned unchanged

### Build Status
- [x] Build passes (cargo build --release)
- [x] All 255 tests pass (cargo test)

---
*Solved by Claude Code*
