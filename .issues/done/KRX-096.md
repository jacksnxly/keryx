---
id: "KRX-096"
title: "Fix repo.head().ok() swallowing non-empty-repo errors in collect_diff"
type: bug
status: done
priority: high
labels: ["silent-failure", "error-handling", "critical-gap"]
created: "2026-02-02"
updated: "2026-02-02"
assignee: null
---

# Fix repo.head().ok() swallowing non-empty-repo errors in collect_diff

## Problem
Both `collect_diff` and `collect_diff_for_paths` call `repo.head().ok().and_then(|r| r.peel_to_tree().ok())`. The `.ok()` silently converts all errors into `None`, not just the expected "no HEAD exists" case for empty repos. Corrupt HEAD, permission errors, or missing objects all get silently swallowed.

## Current Behavior
When `head_tree` is `None` due to an error (not an empty repo), `diff_tree_to_index` compares against an empty tree, causing ALL tracked files to appear as "Added" instead of "Modified". The LLM generates commit messages based on this wrong data.

## Expected Behavior
Distinguish between `UnbornBranch`/`NotFound` (expected for initial commits) and actual errors (corrupt HEAD, permission issues). Actual errors should propagate as `CommitError::DiffFailed`.

## Steps to Reproduce
1. Corrupt `.git/HEAD` or create a shallow clone with missing objects
2. Run `keryx commit`
3. Observe all files show as "Added" with no error

## Acceptance Criteria
- [x] `UnbornBranch` and `NotFound` errors result in `head_tree = None` (empty repo case)
- [x] Other `repo.head()` errors propagate as `CommitError::DiffFailed`
- [x] `peel_to_tree()` errors after successful `head()` also propagate
- [x] Existing tests pass, new test for error discrimination added

## Technical Notes
- File: `src/commit/diff.rs`, lines 57-60 and 117-120
- Suggested fix: Match on `e.code() == git2::ErrorCode::UnbornBranch` / `NotFound`
- Both `collect_diff` and `collect_diff_for_paths` have the same issue
- Found during PR review of `feat/commit-messages`

---

## Resolution

**Completed:** 2026-02-02

### Approach
Extracted a `resolve_head_tree` helper function that uses `match` on `repo.head()` error codes instead of `.ok()`. `UnbornBranch` and `NotFound` errors return `Ok(None)` (empty repo case), while all other errors propagate as `CommitError::DiffFailed`. The `peel_to_tree()` call uses `.map_err(CommitError::DiffFailed)?` since a successful `head()` that fails to peel is always a real error.

### Changes Made
- `src/commit/diff.rs`: Added `resolve_head_tree()` helper, replaced `.ok()` chains in both `collect_diff` and `collect_diff_for_paths`, added 3 new tests

### Testing
- [x] Build passes (cargo build)
- [x] All 398 tests pass (cargo test)
- [x] New test: `test_collect_diff_empty_repo_returns_none_head_tree` - verifies empty repos work
- [x] New test: `test_collect_diff_corrupt_head_propagates_error` - verifies corrupt HEAD returns DiffFailed
- [x] New test: `test_collect_diff_for_paths_corrupt_head_propagates_error` - same for path-scoped variant

---
*Solved by Claude Code*
