# [KRX-048] Add --fixed-strings flag to ripgrep calls to prevent regex injection

**Type:** bug
**Priority:** urgent
**Status:** done
**Updated:** 2026-01-26
**Labels:** security, critical-gap
**Created:** 2026-01-26
**Branch:** feat/agentic-verification

---

## Problem

Keywords extracted from changelog descriptions are passed directly to ripgrep without sanitization. Crafted commit messages or PR bodies could contain regex metacharacters that cause unexpected behavior.

## Current Behavior

```rust
fn search_keyword(keyword: &str, repo_path: &Path) -> Option<SearchResult> {
    let output = Command::new("rg")
        .args([
            "--ignore-case",
            "--files-with-matches",
            // ...
            keyword,  // Unsanitized input passed to rg
        ])
```

Keywords from `extract_keywords()` are passed directly to ripgrep, which interprets them as regex patterns.

## Expected Behavior

Keywords should be treated as literal strings, not regex patterns.

## Attack Vector

A malicious actor could craft a commit message like:
- `Added feature for .*` - matches everything
- `Fixed (a|b|c)+` - causes regex backtracking
- `Support for \x00` - null byte injection

## Acceptance Criteria

- [x] All ripgrep calls in `scanner.rs` use `--fixed-strings` (`-F`) flag
- [x] Keywords are treated as literal text, not regex patterns
- [x] Review all `Command::new("rg")` calls in the codebase

## Technical Notes

**Affected locations in `src/verification/scanner.rs`:**
- `search_keyword()` - lines 178-193, 211-226, 239-254
- `find_stub_indicators_near_keyword()` - lines 280-303
- `search_and_count_array()` - lines 453-478

**Fix:** Add `-F` or `--fixed-strings` to all ripgrep argument lists:
```rust
.args([
    "--ignore-case",
    "--fixed-strings",  // Treat pattern as literal string
    "--files-with-matches",
    // ...
])
```

---

## Resolution

**Completed:** 2026-01-26

### Approach

Added `--fixed-strings` flag to all ripgrep calls that use user-derived keywords. This ensures keywords extracted from commit messages and PR descriptions are treated as literal text, preventing regex injection attacks.

### Changes Made

- `src/verification/scanner.rs:180-195`: Added `--fixed-strings` to files search in `search_keyword()`
- `src/verification/scanner.rs:213-228`: Added `--fixed-strings` to samples search in `search_keyword()`
- `src/verification/scanner.rs:244-258`: Added `--fixed-strings` to count search in `search_keyword()`
- `src/verification/scanner.rs:284-297`: Added `--fixed-strings` to files search in `find_stub_indicators_near_keyword()`
- `src/verification/scanner.rs:312-323`: Added `--fixed-strings` to stub pattern search in `find_stub_indicators_near_keyword()`

### Intentionally Unchanged

- `src/verification/scanner.rs:468-478`: `search_and_count_array()` intentionally uses regex patterns defined in code (`count_patterns`) - NOT user-derived input

### Testing

- [x] Build passes (`cargo build`)
- [x] All 218 tests pass (`cargo test`)
- [x] Clippy passes (warnings are style-only)

---
*Solved by Claude Code*
