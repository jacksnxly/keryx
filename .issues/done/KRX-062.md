---
id: "KRX-062"
title: "Fix incorrect fallback to files.len() when rg --count-matches fails"
type: bug
status: done
priority: urgent
labels: ["error-handling", "silent-failure", "critical-gap"]
created: "2026-01-27"
updated: "2026-01-27"
assignee: null
---

# Fix incorrect fallback to files.len() when rg --count-matches fails

## Problem
When `rg --count-matches` fails, the code falls back to using `files.len()` as the count. This is semantically incorrect (number of files â‰  number of matches) and causes the verification to report false count mismatches.

## Current Behavior
When ripgrep counting fails (memory exhaustion, signal interruption, I/O errors), the code uses the number of files containing matches as the occurrence count. Users see misleading messages like "Count mismatch: claimed 8, found 5" when 5 is the file count, not the actual match count.

## Expected Behavior
When counting fails, either:
1. Return 0 with a flag indicating "count unavailable"
2. Propagate an error to the user
3. At minimum, set `appears_complete = false` and include a note in the evidence

## Steps to Reproduce
1. Generate changelog entries with numeric claims (e.g., "Added 8 templates")
2. Simulate ripgrep count failure (e.g., interrupt mid-count)
3. Observe incorrect count reported in verification evidence

**Environment:** Any environment where ripgrep count-matches can fail

## Acceptance Criteria
- [ ] When `rg --count-matches` fails, the fallback does not produce semantically incorrect data
- [ ] Users can distinguish between "no matches found" and "counting failed"
- [ ] Evidence output clearly indicates when counts are unavailable

## Technical Notes
**Location:** `src/verification/scanner.rs:298-328`

```rust
// Current problematic code:
Ok(out) => {
    warn!("rg --count-matches failed...");
    files.len()  // INCORRECT: file count != occurrence count
}
Err(e) => {
    warn!("Failed to execute rg --count-matches...");
    files.len()  // INCORRECT
}
```

Recommended fix: Return 0 or use `Option<usize>` to indicate unavailable count.

---

## Resolution

**Completed:** 2026-01-27

### Approach
Changed `SearchResult.count` from `usize` to `Option<usize>` to distinguish between a successful count and a counting failure. When `rg --count-matches` fails (error exit code or execution failure), the count is now `None` instead of the incorrect `files.len()` fallback. The caller in `analyze_entry` uses `unwrap_or(0)` for the `occurrence_count` field and marks `appears_complete = false` when counting failed, ensuring confidence scoring is appropriately penalized.

### Changes Made
- `src/verification/scanner.rs`: Changed `SearchResult.count` from `usize` to `Option<usize>`. Updated all three match arms in the `rg --count-matches` block: success returns `Some(sum)`, exit code 1 returns `Some(0)`, error cases return `None`. Updated `analyze_entry` to set `appears_complete = false` when count is unavailable and use `unwrap_or(0)` for the occurrence count.

### Testing
- [x] Build passes (`cargo build`)
- [x] All 154 unit tests pass
- [x] All integration tests pass (14 verification tests)
- [ ] Manual testing required

---
*Solved by Claude Code*
