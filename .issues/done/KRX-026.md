---
id: "KRX-026"
title: "Include original error in RetriesExhausted error variant"
type: improvement
status: done
priority: high
labels: ["error-handling"]
created: "2026-01-26"
updated: "2026-01-26"
assignee: null
---

# Include original error in RetriesExhausted error variant

## Context
When all retry attempts are exhausted, the original error is printed to stderr but then replaced with a generic `RetriesExhausted` error. The calling code loses access to the actual failure reason, making debugging harder.

## Current Implementation
In `src/claude/retry.rs:78-84`:

```rust
// All retries exhausted
if let Some(e) = last_error {
    eprintln!("All {} attempts failed. Last error: {}", MAX_ATTEMPTS, e);
}

Err(ClaudeError::RetriesExhausted)
```

The error is printed but not preserved in the returned error.

## Proposed Improvement
Include the last error as the source in `RetriesExhausted`, so callers can access the actual failure reason.

## Acceptance Criteria
- [x] `RetriesExhausted` variant includes the last error
- [x] Error chain is preserved for logging/debugging
- [x] Display impl shows both "retries exhausted" and the cause

## Technical Notes
**File:** `src/error.rs` and `src/claude/retry.rs:78-84`

Suggested changes:

1. Update error type in `src/error.rs`:
```rust
#[derive(Error, Debug)]
pub enum ClaudeError {
    // ...
    #[error("All retry attempts failed: {0}")]
    RetriesExhausted(Box<ClaudeError>),
}
```

2. Update retry logic:
```rust
Err(ClaudeError::RetriesExhausted(Box::new(
    last_error.expect("Should have error after failed retries")
)))
```

---

## Resolution

**Completed:** 2026-01-26

### Approach
Updated `RetriesExhausted` error variant to include the last error using `Box<ClaudeError>` with the `#[source]` attribute for proper error chain support. Removed the redundant `eprintln!` workaround since the error is now properly propagated.

### Changes Made
- `src/error.rs:61-62`: Changed `RetriesExhausted` from unit variant to `RetriesExhausted(#[source] Box<ClaudeError>)` with updated error message format
- `src/claude/retry.rs:78-84`: Removed `eprintln!` workaround and now pass the last error to `RetriesExhausted` constructor
- `src/claude/retry.rs:239`: Updated test assertion to match new variant pattern `RetriesExhausted(_)`
- `src/claude/retry.rs:369`: Enhanced test to verify the last error type is preserved in the error chain

### Testing
- [x] Build passes (`cargo check`)
- [x] 146 tests pass (`cargo test`)
- [x] Clippy passes (`cargo clippy`)
- [x] Test verifies last error is preserved in error chain

---
*Solved by Claude Code*
