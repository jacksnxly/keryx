---
id: "KRX-070"
title: "Extract repeated ripgrep argument patterns into constants"
type: improvement
status: done
priority: medium
labels: ["code-quality"]
created: "2026-01-27"
updated: "2026-01-27"
assignee: null
---

# Extract repeated ripgrep argument patterns into constants

## Context
The same ripgrep arguments are repeated 5+ times across different functions in scanner.rs, violating DRY principles and making maintenance difficult.

## Current State
These arguments appear in lines 178-191, 233-248, 281-295, 343-355, 598-607:
```rust
"-g", "!target",
"-g", "!node_modules",
"-g", "!dist",
"-g", "!build",
"-g", "!.git",
```

And type definitions:
```rust
"--type-add", "code:*.{rs,ts,tsx,js,jsx,py,go,java,c,cpp,h,hpp}",
"--type", "code",
```

## Desired State
Extract into constants and helper functions:
```rust
const RG_EXCLUDE_PATTERNS: &[&str] = &[
    "-g", "!target",
    "-g", "!node_modules",
    "-g", "!dist",
    "-g", "!build",
    "-g", "!.git",
];

const RG_CODE_TYPE: &[&str] = &[
    "--type-add", "code:*.{rs,ts,tsx,js,jsx,py,go,java,c,cpp,h,hpp}",
    "--type", "code",
];

fn build_rg_command(keyword: &str, repo_path: &Path) -> Command {
    let mut cmd = Command::new("rg");
    cmd.args(["--ignore-case", "--fixed-strings"]);
    cmd.args(RG_CODE_TYPE);
    cmd.args(RG_EXCLUDE_PATTERNS);
    cmd.arg(keyword);
    cmd.current_dir(repo_path);
    cmd
}
```

## Acceptance Criteria
- [x] Common ripgrep exclude patterns extracted to constant
- [x] Common file type definition extracted to constant
- [x] Helper function for building standard rg commands
- [x] All usages updated to use shared definitions

## Technical Notes
**Location:** `src/verification/scanner.rs`

This also enables easier testing and configuration of excluded patterns.

---

## Resolution

**Completed:** 2026-01-27

### Approach
Extracted repeated ripgrep argument patterns into module-level constants (`RG_EXCLUDE_PATTERNS`, `RG_CODE_TYPE`) and created a `build_rg_keyword_command` helper function that builds a standard `Command` with common arguments. Functions that needed only exclude patterns (not code type) use the constant directly. The `search_and_count_array` function also benefited from using `RG_EXCLUDE_PATTERNS`, which fixed an inconsistency where it was missing `-g !build` and `-g !.git` exclusions.

### Changes Made
- `src/verification/scanner.rs`: Added `RG_EXCLUDE_PATTERNS` and `RG_CODE_TYPE` constants, added `build_rg_keyword_command` helper, updated 5 ripgrep invocations across `search_keyword`, `find_stub_indicators_near_keyword`, and `search_and_count_array`

### Testing
- [x] Build passes (`cargo build`)
- [x] All 165 unit tests pass (`cargo test`)
- [x] All integration tests pass

---
*Solved by Claude Code*
