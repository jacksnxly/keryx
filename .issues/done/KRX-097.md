---
id: "KRX-097"
title: "Add LlmError::ResponseParseFailed variant for JSON parse failures"
type: improvement
status: done
priority: high
labels: ["error-handling", "code-quality"]
created: "2026-02-02"
updated: "2026-02-02"
assignee: null
---

# Add LlmError::ResponseParseFailed variant for JSON parse failures

## Context
When `generate_commit_message` fails to parse LLM JSON output, it fabricates an `LlmError::AllProvidersFailed` with the same provider for both primary and fallback, and hardcodes `ClaudeError::InvalidJson` regardless of actual provider. This produces misleading error messages (blames Claude when using Codex, says "both providers failed" when only parsing failed).

## Current Implementation
`src/commit/message.rs` lines 100-120 manually constructs:
```rust
LlmError::AllProvidersFailed {
    primary: completion.provider,     // could be Codex
    primary_error: LlmProviderError::Claude(ClaudeError::InvalidJson(...)), // always Claude
    fallback: completion.provider,    // same as primary
    fallback_error: LlmProviderError::Claude(...), // dummy
}
```

Additionally, `CommitError::InvalidResponse` exists in `src/error.rs` line 146 but is never used -- it was likely intended for this purpose.

## Proposed Improvement
1. Add `LlmError::ResponseParseFailed { provider: Provider, raw_output: String, parse_error: String }` to `src/llm/router.rs`
2. Add `summary()` and `detailed()` implementations for the new variant
3. Use it in `generate_commit_message` instead of the fabricated error
4. Either use or remove the dead `CommitError::InvalidResponse` variant

## Acceptance Criteria
- [ ] New `LlmError::ResponseParseFailed` variant exists with provider, raw output, and parse error
- [ ] `generate_commit_message` uses the new variant on JSON parse failure
- [ ] Error messages correctly identify the provider that returned unparseable output
- [ ] `CommitError::InvalidResponse` is either used or removed
- [ ] Existing tests pass

## Technical Notes
- Files: `src/llm/router.rs` (add variant), `src/commit/message.rs` (use variant), `src/error.rs` (clean up dead variant)
- The `summary()` and `detailed()` methods on `LlmError` need match arms for the new variant
- `handle_llm_error` in `main.rs` also needs to handle the new variant
- Found during PR review of `feat/commit-messages`

---

## Resolution

**Completed:** 2026-02-02

### Approach
Added a dedicated `LlmError::ResponseParseFailed` variant to accurately represent JSON parse failures from any LLM provider, replacing the fabricated `AllProvidersFailed` workaround that incorrectly blamed Claude regardless of actual provider. Removed the dead `CommitError::InvalidResponse` variant that was never used.

### Changes Made
- `src/llm/router.rs`: Added `ResponseParseFailed { provider, raw_output, parse_error }` variant to `LlmError` with `summary()`, `detailed()`, `primary_error()`, and `fallback_error()` implementations
- `src/commit/message.rs`: Replaced fabricated `AllProvidersFailed` error with `ResponseParseFailed`, removed unused `LlmProviderError` import and TODO comment
- `src/error.rs`: Removed dead `CommitError::InvalidResponse(String)` variant

### Testing
- [x] Build passes (`cargo build`)
- [x] All 398 tests pass (`cargo test`)
- [ ] Manual testing required

---
*Solved by Claude Code*
