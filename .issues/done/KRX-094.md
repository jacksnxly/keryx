---
id: "KRX-094"
title: "Replace stringly-typed bump_type with enum in VersionBumpResponse"
type: improvement
status: in-review
priority: low
labels: ["code-quality"]
created: "2026-02-02"
updated: "2026-02-02"
assignee: null
---

# Replace stringly-typed bump_type with enum in VersionBumpResponse

## Context
`VersionBumpResponse` uses `bump_type: String` which is then manually matched against "major"/"minor"/"patch" in `parse_version_bump_response`. The valid set of values is not expressed in the type definition. This is the same "stringly-typed" anti-pattern that was fixed in KRX-087 by replacing string indicators with the `StubType` enum.

## Current Implementation
```rust
#[derive(Deserialize)]
struct VersionBumpResponse {
    bump_type: String,     // Any string accepted
    reasoning: String,
}

// Manual string matching later:
let bump = match parsed.bump_type.to_lowercase().as_str() {
    "major" => BumpType::Major,
    "minor" => BumpType::Minor,
    "patch" => BumpType::Patch,
    _ => return None,
};
```

## Proposed Improvement
Use a typed enum for deserialization. Since `BumpType` already exists with the correct variants, either:

**Option A**: Add `#[derive(Deserialize)]` with case-insensitive deserialization to `BumpType` directly.

**Option B**: Create a private `RawBumpType` enum local to `llm_bump.rs`:
```rust
#[derive(Deserialize)]
#[serde(rename_all = "lowercase")]
enum RawBumpType { Major, Minor, Patch }
```

Also consider making `reasoning` optional (`Option<String>`) so that a correct bump_type is not discarded merely because the reasoning field is missing.

## Acceptance Criteria
- [ ] `bump_type` field uses a typed enum instead of `String`
- [ ] Invalid bump types are rejected at deserialization time
- [ ] Case-insensitive deserialization works (LLMs may return "MINOR" or "Minor")
- [ ] Existing tests pass (update string matching tests to use enum)
- [ ] Consider making `reasoning` optional

## Technical Notes
- File: `src/version/llm_bump.rs:25-29`
- `BumpType` is defined in `src/version/bump.rs:8-13`
- serde `rename_all = "lowercase"` handles the case mapping
- For case-insensitive deserialization, a custom deserializer or `#[serde(alias)]` may be needed
- Flagged by: type-design-analyzer

---

## Resolution

**Completed:** 2026-02-02

### Approach
Used **Option B** from the issue: created a private `RawBumpType` enum local to `llm_bump.rs` with a custom `Deserialize` implementation that lowercases input before matching. This avoids coupling `BumpType` (in `bump.rs`) to serde. Added `From<RawBumpType> for BumpType` conversion. Made `reasoning` field `Option<String>`.

### Changes Made
- `src/version/llm_bump.rs`: Added `RawBumpType` enum with custom case-insensitive deserializer, `From` impl to `BumpType`, changed `VersionBumpResponse.bump_type` from `String` to `RawBumpType`, changed `reasoning` from `String` to `Option<String>`, simplified `parse_version_bump_response` to remove manual string matching, updated tests for optional reasoning and added mixed-case test

### Acceptance Criteria
- [x] `bump_type` field uses a typed enum instead of `String`
- [x] Invalid bump types are rejected at deserialization time
- [x] Case-insensitive deserialization works (LLMs may return "MINOR" or "Minor")
- [x] Existing tests pass (updated string matching tests to use enum)
- [x] `reasoning` made optional (`Option<String>`)

### Testing
- [x] Build passes (cargo build)
- [x] 355 tests pass (cargo test)
- [x] New tests: `test_parse_missing_reasoning_succeeds`, `test_parse_case_insensitive_mixed_case`
- [ ] Manual testing required

---
*Solved by Claude Code*
