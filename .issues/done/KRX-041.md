---
id: "KRX-041"
title: "Improve timestamp fallback visibility"
type: improvement
status: done
priority: medium
labels: ["error-handling", "ux"]
created: "2026-01-26"
updated: "2026-01-26"
assignee: "jacksonly"
---

# Improve timestamp fallback visibility

## Problem
When a commit has an invalid timestamp, the code falls back to `Utc::now()` with only a warning log that's not visible without `--verbose`. This could cause incorrect date ordering in changelogs.

## Current Behavior
```rust
let timestamp = match Utc.timestamp_opt(time.seconds(), 0).single() {
    Some(ts) => ts,
    None => {
        warn!(/* ... */);
        Utc::now()
    }
};
```

Warning only visible with `--verbose` flag.

## Expected Behavior
Make timestamp fallback more visible, especially since it affects date-based operations and sorting.

## Acceptance Criteria
- [x] Timestamp fallback logs include commit hash and original timestamp value
- [x] Consider printing warning to stderr (not just log) for important cases
- [x] Consider failing in `--strict` mode

## Technical Notes
**File:** `src/git/commits.rs:72-82`

The fallback to current time can cause incorrect date ordering. Consider whether `--strict` mode should reject commits with invalid timestamps rather than silently using current time.

---

## Resolution

**Completed:** 2026-01-26

### Approach
Implemented a two-tier approach for handling invalid timestamps:
1. **Non-strict mode (default):** Prints a visible warning to stderr (with yellow color) and falls back to `Utc::now()`, making the issue visible without `--verbose`
2. **Strict mode (`--strict`):** Returns an error instead of falling back, allowing users to enforce strict data integrity

### Changes Made
- `src/error.rs`: Added `InvalidTimestamp` error variant with commit hash and seconds value
- `src/git/commits.rs`:
  - Modified `from_git2_commit()` to accept `strict: bool` parameter
  - Added stderr warning with colored output when timestamp is invalid (non-strict)
  - Returns `GitError::InvalidTimestamp` error in strict mode
  - Modified `fetch_commits()` to accept and pass `strict` parameter
- `src/main.rs`:
  - Updated `run_init()`, `run_init_unreleased()`, `run_init_from_history()` to accept `strict` parameter
  - Passed `cli.strict` to all `fetch_commits()` calls throughout the codebase

### Research Sources
- N/A (Pattern already established in codebase for PR fetch error handling)

### Testing
- [x] Build passes (`cargo build`)
- [x] All 191 tests pass (`cargo test`)
- [ ] Manual testing recommended for edge cases with invalid timestamps

---
*Solved by Claude Code*
