---
id: "KRX-088"
title: "Fix unwrap_claude_envelope ignoring is_error flag"
type: bug
status: in-review
priority: urgent
labels: ["critical-gap", "error-handling", "silent-failure"]
created: "2026-02-02"
updated: "2026-02-02"
assignee: null
---

# Fix unwrap_claude_envelope ignoring is_error flag

## Problem
`unwrap_claude_envelope` in `src/claude/retry.rs:156-167` deserializes the Claude CLI JSON envelope but completely ignores the `is_error` field. When Claude returns an error (auth failure, rate limit, internal error), the error message text is returned as if it were a valid LLM response.

Combined with the silent fallback in `determine_version_with_llm`, the failure chain is: Claude rejects request → error text flows through → JSON parsing fails → algorithmic fallback used — all with zero user-visible indication.

## Current Behavior
`unwrap_claude_envelope` unconditionally returns `envelope.result` even when `is_error: true`. The doc comment says "callers that care should check separately" but the `String` return type gives callers no mechanism to check.

The sibling function `parse_claude_response` at line 170 of the same file correctly checks `is_error` and returns `Err(ClaudeError::ExecutionFailed(...))`.

## Expected Behavior
`unwrap_claude_envelope` should detect `is_error: true` and either return an error or at minimum log a warning. Returning `Result<String, ClaudeError>` would allow the retry logic to retry on envelope errors and surface the failure.

## Steps to Reproduce
1. Configure Claude CLI with expired/invalid credentials
2. Run `keryx generate` (without `--no-llm-bump`)
3. Observe that the version bump silently uses the algorithmic approach with no error message

## Acceptance Criteria
- [x] `unwrap_claude_envelope` returns `Result<String, ClaudeError>`
- [x] `is_error: true` envelopes return `Err(ClaudeError::ExecutionFailed(...))`
- [x] `generate_raw_with_retry_impl` propagates the error (enabling retry)
- [x] Unit tests cover: valid envelope, non-JSON fallback, and error envelope cases
- [x] `parse_claude_response` is refactored to use `unwrap_claude_envelope` to eliminate duplication

## Technical Notes
- File: `src/claude/retry.rs:156-167`
- Related: `parse_claude_response` at line 170 has the correct pattern
- The `ClaudeCliResponse` struct at line 147 already has the `is_error: bool` field
- Flagged by: code-reviewer, silent-failure-hunter, comment-analyzer

---

## Resolution

**Completed:** 2026-02-02

### Approach
Changed `unwrap_claude_envelope` from returning `String` to `Result<String, ClaudeError>`, checking the `is_error` flag and returning `Err(ClaudeError::ExecutionFailed(...))` when true. Refactored `parse_claude_response` to call `unwrap_claude_envelope` instead of duplicating envelope-parsing logic. Updated `generate_raw_with_retry_impl` to match on the Result, enabling retry on envelope errors.

### Changes Made
- `src/claude/retry.rs`: Changed `unwrap_claude_envelope` signature to `Result<String, ClaudeError>`, added `is_error` check
- `src/claude/retry.rs`: Updated `generate_raw_with_retry_impl` caller to propagate envelope errors into retry loop
- `src/claude/retry.rs`: Refactored `parse_claude_response` to use `unwrap_claude_envelope` (eliminated ~15 lines of duplication)
- `src/claude/retry.rs`: Added 6 new unit tests (envelope valid, non-JSON fallback, error flag, missing is_error default, raw retry on envelope error, parse_claude_response error envelope)

### Testing
- [x] Build passes (`cargo build`)
- [x] All 227 unit tests pass
- [x] All integration tests pass
- [x] 6 new tests specifically for envelope unwrapping and error propagation

---
*Solved by Claude Code*
