---
id: "KRX-017"
title: "Add timeout to Claude subprocess execution"
type: bug
status: done
priority: urgent
labels: ["critical-gap", "error-handling", "concurrency"]
created: "2026-01-25"
updated: "2026-01-25"
assignee: null
---

# Add timeout to Claude subprocess execution

## Problem
The Claude subprocess execution in `src/claude/subprocess.rs` has no timeout configured. If Claude hangs indefinitely, the program will hang forever. The `ClaudeError::Timeout` variant exists but is never used.

## Current Behavior
The code spawns a Claude subprocess and waits indefinitely for it to complete:
```rust
let output = Command::new("claude")
    .arg("-p")
    .arg(prompt)
    .output()
    .await
    .map_err(ClaudeError::SpawnFailed)?;
```

If Claude hangs (network issues, API problems, infinite loop), the user must forcefully kill the process.

## Expected Behavior
The subprocess should have a configurable timeout (e.g., 5 minutes by default). If the timeout is exceeded, return `ClaudeError::Timeout` with the duration.

## Steps to Reproduce
1. Run keryx when Claude API is unresponsive
2. Observe program hangs indefinitely
3. Must use Ctrl+C to terminate

**Environment:** All platforms

## Acceptance Criteria
- [x] Subprocess has a default timeout (e.g., 300 seconds)
- [x] Timeout is configurable via CLI flag or environment variable
- [x] `ClaudeError::Timeout` is returned when timeout exceeded
- [x] Error message indicates the timeout duration
- [x] Subprocess is properly terminated when timeout occurs

## Technical Notes
**File:** `src/claude/subprocess.rs:37-57`

**Recommended fix:**
```rust
use tokio::time::{timeout, Duration};

let output = timeout(
    Duration::from_secs(300),
    Command::new("claude")
        .arg("-p")
        .arg(prompt)
        .output()
).await
.map_err(|_| ClaudeError::Timeout(300))?
.map_err(ClaudeError::SpawnFailed)?;
```

**Dependencies:** None - `tokio::time::timeout` is already available.

**Related:** This was identified in the PR review as a critical issue that could cause production hangs.

---

## Resolution

**Completed:** 2026-01-25

### Approach
Wrapped the Claude subprocess execution in `tokio::time::timeout` with a configurable timeout duration. Added environment variable support (`KERYX_CLAUDE_TIMEOUT`) to allow users to override the default 5-minute timeout.

### Changes Made
- `src/claude/subprocess.rs`:
  - Added `DEFAULT_TIMEOUT_SECS` constant (300 seconds)
  - Added `TIMEOUT_ENV_VAR` constant for `KERYX_CLAUDE_TIMEOUT`
  - Added `get_timeout()` function to read timeout from env or use default
  - Wrapped `Command::new("claude")...output()` in `tokio::time::timeout()`
  - Returns `ClaudeError::Timeout(secs)` when timeout exceeded
  - Added 4 unit tests for timeout configuration

### Research Sources
- Tokio documentation: `tokio::time::timeout` function
- Issue recommended approach followed directly

### Testing
- [x] Build passes (`cargo build`)
- [x] Type checks pass (`cargo check --all-targets`)
- [x] All 139 tests pass (73 unit + 66 integration)
- [ ] Manual testing required (requires simulating Claude hang)

---
*Solved by Claude Code*
