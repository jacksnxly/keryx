# [KRX-050] Log warnings when external commands fail in verification scanner

**Type:** improvement
**Priority:** high
**Status:** in-review
**Labels:** error-handling, silent-failure
**Created:** 2026-01-26
**Branch:** feat/agentic-verification

---

## Problem

Multiple functions in `scanner.rs` silently swallow errors from external commands, making debugging extremely difficult.

## Current Behavior

Throughout `scanner.rs`, command failures are silently ignored:

```rust
// search_keyword - line 196-205
_ => return None,  // Silent failure

// sample lines search - line 229-238
_ => Vec::new(),  // Silent empty result

// count command - line 257-267
_ => files.len(),  // Silent fallback to incorrect value

// stub file search - line 295-303
_ => return indicators,  // Silent empty return

// find command - line 425-449
_ => None,  // Silent failure
```

## Expected Behavior

At minimum, log warnings when commands fail so users can diagnose issues. Better: distinguish between "no matches found" (normal) and "command failed" (error).

## Acceptance Criteria

- [ ] Add `warn!()` logging for command failures in `search_keyword()`
- [ ] Add `warn!()` logging for command failures in `find_stub_indicators_near_keyword()`
- [ ] Add `warn!()` logging for command failures in `count_files_matching()`
- [ ] Distinguish `rg` exit code 1 (no matches - OK) from other errors
- [ ] In verbose mode, show what tools are being used and their results

## Technical Notes

**Ripgrep exit codes:**
- 0 = matches found
- 1 = no matches found (this is OK, not an error)
- 2 = error occurred

**Example fix for `search_keyword`:**
```rust
match output {
    Ok(out) if out.status.success() => { ... }
    Ok(out) if out.status.code() == Some(1) => {
        // No matches found - this is normal
        return None;
    }
    Ok(out) => {
        let stderr = String::from_utf8_lossy(&out.stderr);
        warn!("rg failed for keyword '{}': {}", keyword, stderr);
        return None;
    }
    Err(e) => {
        if e.kind() == std::io::ErrorKind::NotFound {
            warn!("ripgrep (rg) not found - install with: cargo install ripgrep");
        } else {
            warn!("Failed to execute rg: {}", e);
        }
        return None;
    }
}
```

---

## Resolution

**Completed:** 2026-01-27

### Approach

Implemented proper error handling with `warn!()` logging across all functions that execute external commands (`rg` and `find`). Each match expression now:
1. Distinguishes between success, no-matches (exit code 1 for rg - normal), and actual errors
2. Logs warnings with contextual information when commands fail
3. Handles the special case of command not found (e.g., ripgrep not installed)

### Changes Made

- `src/verification/scanner.rs`:
  - Added `warn` import from tracing
  - **`search_keyword()`**: Added error handling for file search, sample lines, and count operations
  - **`find_stub_indicators_near_keyword()`**: Added error handling with rg exit code distinction
  - **`count_files_matching()`**: Added warning logging for find command failures
  - **`search_and_count_array()`**: Added error handling with rg exit code distinction

### Acceptance Criteria Status

- [x] Add `warn!()` logging for command failures in `search_keyword()`
- [x] Add `warn!()` logging for command failures in `find_stub_indicators_near_keyword()`
- [x] Add `warn!()` logging for command failures in `count_files_matching()`
- [x] Distinguish `rg` exit code 1 (no matches - OK) from other errors
- [ ] In verbose mode, show what tools are being used and their results (out of scope - would require additional tracing infrastructure)

### Testing

- [x] Build passes (`cargo build`)
- [x] All 114 tests pass (`cargo test`)
- [ ] Manual testing with verbose mode

---
*Solved by Claude Code*
