---
id: "KRX-082"
title: "Preserve Option<usize> for KeywordMatch occurrence_count to distinguish failure from zero"
type: improvement
status: in-review
priority: high
labels: ["code-quality", "silent-failure"]
created: "2026-01-27"
updated: "2026-01-28"
assignee: null
---

# Preserve Option<usize> for KeywordMatch occurrence_count to distinguish failure from zero

## Context
`SearchResult::count` is `Option<usize>` to correctly distinguish "counting failed" from "counted zero occurrences." However, this distinction is lost when constructing `KeywordMatch` via `occurrence_count: match_result.count.unwrap_or(0)` at scanner.rs:114. A counting failure becomes `occurrence_count: 0`, which is semantically identical to "zero occurrences found."

## Current Implementation
```rust
// scanner.rs:114
occurrence_count: match_result.count.unwrap_or(0),
```

This means evidence data sent to Claude for verification may contain `occurrence_count: 0` for keywords where counting failed, making it look like the feature does not exist.

## Proposed Improvement
Change `KeywordMatch::occurrence_count` from `usize` to `Option<usize>`. Update the serialization, confidence scoring, and evidence consumers to handle `None` as "unable to count" rather than "zero."

## Acceptance Criteria
- [x] `KeywordMatch::occurrence_count` is `Option<usize>`
- [x] `None` = counting failed, `Some(0)` = counted zero
- [x] Confidence scoring treats `None` appropriately (e.g., no boost for unknown count)
- [x] Serialized evidence clearly distinguishes the two cases
- [x] Unit tests updated

## Technical Notes
- **Files:** `src/verification/evidence.rs` (type definition), `src/verification/scanner.rs:114` (construction)
- Related to KRX-074 (count verification defaults)
- The `appears_complete` field partially captures this via `match_result.count.is_some()`, but the information is conflated with stub detection

---

## Resolution

**Completed:** 2026-01-28

### Approach
Changed `KeywordMatch::occurrence_count` from `usize` to `Option<usize>` to preserve the semantic distinction between "counting failed" (`None`) and "counted zero occurrences" (`Some(0)`).

### Changes Made
- `src/verification/evidence.rs`: Changed `occurrence_count` type from `usize` to `Option<usize>`, updated confidence scoring logic to handle `None` appropriately (no boost for unknown count), added 3 new unit tests for the distinction
- `src/verification/scanner.rs`: Updated `KeywordMatch` construction to pass `match_result.count` directly instead of `unwrap_or(0)`, updated test fixtures to use `Some(n)` syntax
- `src/claude/prompt.rs`: Updated test fixture to use `Some(5)` syntax

### Testing
- [x] Build passes (172 tests)
- [x] Type checks pass
- [x] New tests added for `None` vs `Some(0)` serialization and confidence scoring
- [ ] Manual testing required

---
*Solved by Claude Code*
