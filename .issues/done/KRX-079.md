---
id: "KRX-079"
title: "Fix sanitize_for_prompt panic on multi-byte UTF-8 truncation boundary"
type: bug
status: in-review
priority: high
labels: ["bug"]
created: "2026-01-27"
updated: "2026-01-28"
assignee: null
---

# Fix sanitize_for_prompt panic on multi-byte UTF-8 truncation boundary

## Problem
`sanitize_for_prompt` in `prompt.rs:222-228` calls `String::truncate(MAX_INPUT_LENGTH)` before checking the char boundary. `String::truncate()` panics if the index is not on a character boundary. The `while` loop correction runs after the truncation, but the truncation itself may already have panicked.

## Current Behavior
```rust
if result.len() > MAX_INPUT_LENGTH {
    result.truncate(MAX_INPUT_LENGTH);  // Can panic here!
    while !result.is_char_boundary(result.len()) {
        result.pop();
    }
}
```

## Expected Behavior
Find the character boundary before truncating, matching the pattern already used correctly in `gather_key_files` at scanner.rs:820-825.

## Steps to Reproduce
1. Provide a commit message or PR body containing multi-byte UTF-8 characters
2. Content length must exceed `MAX_INPUT_LENGTH` with the truncation point falling mid-character
3. Observe panic

## Acceptance Criteria
- [x] Find char boundary before truncating (not after)
- [x] Match the pattern used in `gather_key_files`
- [x] Add a test with multi-byte content at the truncation boundary

## Technical Notes
- **File:** `src/claude/prompt.rs:222-228`
- Correct pattern (already in scanner.rs:820-825):
  ```rust
  let mut end = MAX_INPUT_LENGTH;
  while end > 0 && !result.is_char_boundary(end) {
      end -= 1;
  }
  result.truncate(end);
  ```

---

## Resolution

**Completed:** 2026-01-28

### Approach
Changed the truncation logic to find the character boundary BEFORE calling `truncate()`, matching the safe pattern already used in `scanner.rs:820-825`.

### Changes Made
- `src/claude/prompt.rs:221-228`: Fixed truncation to find char boundary before truncating
  - Old: `result.truncate(MAX_INPUT_LENGTH)` followed by boundary fix
  - New: Find boundary first with `while` loop, then truncate to safe index

### Test Added
- `test_sanitize_multibyte_utf8_truncation_boundary`: Creates a string where `MAX_INPUT_LENGTH` falls in the middle of a 4-byte emoji (ðŸŽ‰) and verifies no panic occurs

### Build Status
- [x] Build passes (cargo build --release)
- [x] All 169 unit tests pass
- [x] All integration tests pass

---
*Solved by Claude Code*
