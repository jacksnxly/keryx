---
id: "KRX-085"
title: "Track search failures in analyze_entry confidence scoring"
type: improvement
status: in-review
priority: medium
labels: ["error-handling", "code-quality"]
created: "2026-01-29"
updated: "2026-01-29"
assignee: null
---

# Track search failures in analyze_entry confidence scoring

## Context
When `search_keyword` returns an error in `analyze_entry`, it's logged via `warn!` but the keyword is simply skipped. This could result in higher confidence scores than warranted if ripgrep intermittently fails (e.g., due to race conditions, PATH changes, or intermittent errors).

Identified during PR review of feat/agentic-verification branch.

## Current Implementation
At `src/verification/scanner.rs:183-188`:
```rust
Ok(None) => {
    // No matches found - this is normal, skip this keyword
}
Err(e) => {
    warn!("Error searching for keyword '{}': {}", keyword, e);
}
```

Both paths effectively continue silently. Hidden errors include:
- `VerificationError::RipgrepFailed` - could indicate corrupted installation
- `VerificationError::RipgrepNotInstalled` - should fail early
- `VerificationError::ScannerIoError` - could indicate disk/permission issues

## Proposed Improvement
Track search failures and factor them into confidence scoring. Options:
1. Track `search_failures` count and reduce confidence proportionally
2. Add a "search_failed" indicator to `KeywordMatch`
3. Propagate critical rg failures more explicitly

Example approach:
```rust
Err(e) => {
    warn!("Error searching for keyword '{}': {}", keyword, e);
    search_failures += 1;
}
// Later: reduce confidence if search_failures > 0
```

## Acceptance Criteria
- [x] Search failures are tracked during keyword analysis
- [x] Confidence score is reduced when searches fail
- [x] User can see in output that some searches failed
- [x] Critical errors (RipgrepNotInstalled) still fail fast at verification start

## Technical Notes
- Location: `src/verification/scanner.rs:183-188`
- Related: `EntryEvidence::confidence()` at `evidence.rs:61-108`
- Severity: Medium (from PR review)

---

## Resolution

**Completed:** 2026-01-29

### Approach
Implemented a `ScanSummary` struct to track keyword search outcomes during entry analysis. Each search is recorded as either successful (including "no matches found") or failed. The failure count is then used to apply a confidence penalty of -10 points per failed search, consistent with the existing penalty for unverifiable count checks.

### Changes Made
- `src/verification/evidence.rs`:
  - Added `ScanSummary` struct with `total_keywords`, `successful_searches`, `failed_searches` fields
  - Added helper methods: `new()`, `add_keyword()`, `add_success()`, `add_failure()`, `has_failures()`, `failure_rate()`
  - Added `scan_summary: ScanSummary` field to `EntryEvidence` struct
  - Updated `EntryEvidence::new()` constructor to require `scan_summary` parameter
  - Updated `confidence()` method to apply `-10` penalty per failed search
  - Updated `Serialize` implementation to include `scan_summary` (7 fields instead of 6)
  - Added 10 new tests for `ScanSummary` functionality and confidence penalty

- `src/verification/scanner.rs`:
  - Updated `analyze_entry()` to track search outcomes with `ScanSummary`
  - Records successful searches for both `Ok(Some(_))` (matches found) and `Ok(None)` (no matches)
  - Records failed searches for `Err(_)` cases
  - Passes `scan_summary` to `EntryEvidence::new()`
  - Updated imports to include `ScanSummary`
  - Updated existing tests to use new constructor signature

- `src/verification/mod.rs`:
  - Exported `ScanSummary` from the module

- `src/main.rs`:
  - Added display of search failures in low confidence entry warnings
  - Added summary of total search failures across all entries

- `src/claude/prompt.rs`:
  - Updated test functions to use new `EntryEvidence::new()` signature

### Research Sources
- [Rust By Example - Iterating over Results](https://doc.rust-lang.org/rust-by-example/error/iter_result.html)
- [Google Cloud - Design for Graceful Degradation](https://docs.cloud.google.com/architecture/framework/reliability/graceful-degradation)
- [Netflix Tech Blog - Making the Netflix API More Resilient](https://netflixtechblog.com/making-the-netflix-api-more-resilient-a8ec62159c2d)

### Testing
- [x] Build passes (`cargo build --release`)
- [x] All 189 unit tests pass
- [x] 17 integration tests pass
- [ ] Manual testing required

---
*Solved by Claude Code*
