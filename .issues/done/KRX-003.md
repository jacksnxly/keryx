---
id: "KRX-003"
title: "Add logging for Claude CLI envelope parsing fallback"
type: bug
status: done
priority: medium
labels: [error-handling, silent-failure]
created: "2026-01-25"
updated: "2026-01-25"
assignee: null
---

# Add logging for Claude CLI envelope parsing fallback

## Problem
When parsing the Claude CLI JSON envelope fails, the code silently falls back to treating the entire response as raw text, masking potential version mismatches or protocol changes.

## Current Behavior
In `src/claude/retry.rs:82-85`:
```rust
} else {
    // Fallback: treat as raw response
    response.to_string()
};
```
No logging when fallback occurs.

## Expected Behavior
Log when falling back to raw response parsing to help diagnose Claude CLI version issues.

## Acceptance Criteria
- [x] Fallback behavior is logged at debug level
- [x] Log message suggests possible cause (version mismatch)
- [x] Existing fallback behavior is preserved

## Technical Notes
**File:** `src/claude/retry.rs:82-85`

Suggested fix:
```rust
} else {
    tracing::debug!(
        "Could not parse as Claude CLI envelope, treating as raw response. \
         This may indicate a Claude CLI version mismatch."
    );
    response.to_string()
};
```

---

## Resolution

**Completed:** 2026-01-25

### Approach
Added `tracing::debug!` logging to the fallback branch when Claude CLI JSON envelope parsing fails. The `tracing` crate was already a dependency in the project, making this a straightforward addition.

### Changes Made
- `src/claude/retry.rs:82-88`: Added debug-level logging when falling back to raw response parsing

### Build Status
- [x] `cargo check` passes
- [x] `cargo test` passes (89 tests)

### Next Steps
1. Review the changes
2. Move to `done/` when verified

---
*Solved by Claude Code*
