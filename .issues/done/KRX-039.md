---
id: "KRX-039"
title: "Fix TOCTOU race condition in changelog write"
type: bug
status: done
priority: high
labels: ["concurrency", "bug"]
created: "2026-01-26"
updated: "2026-01-26"
assignee: null
---

# Fix TOCTOU race condition in changelog write

## Problem
There is a time-of-check-time-of-use (TOCTOU) race between reading the changelog and writing to it. Another process could modify the changelog between read and write operations.

## Current Behavior
```rust
let existing = read_changelog(path)?;  // Read
// ... processing ...
std::fs::write(path, new_content)?;    // Write - file may have changed
```

No file locking or atomic write protection.

## Expected Behavior
Changelog writes should be atomic to prevent data loss if another process modifies the file.

## Steps to Reproduce
1. Run two instances of `keryx` simultaneously in CI
2. Both try to update the same changelog
3. One process's changes may be lost

**Environment:** CI environments with parallel jobs

## Acceptance Criteria
- [x] Changelog writes are atomic (temp file + rename)
- [ ] OR file locking prevents concurrent writes
- [x] Data loss prevented when multiple processes access the file

## Technical Notes
**File:** `src/changelog/writer.rs:26-53`

Options:
1. Use `fs2` crate for file locking
2. Write to temp file then atomic rename
3. Both approaches for maximum safety

Consider `tempfile` crate for safe temp file creation.

---

## Resolution

**Completed:** 2026-01-26

### Approach
Implemented atomic file writes using the `tempfile` crate with the standard temp file + rename pattern. This prevents TOCTOU race conditions by:
1. Creating a temporary file in the same directory as the target
2. Writing all content to the temp file
3. Calling `sync_all()` to ensure durability
4. Atomically renaming the temp file to the target path

This is the same pattern used by Cargo (Rust's official package manager) for its own file operations.

### Changes Made
- `Cargo.toml`: Moved `tempfile = "3"` from dev-dependencies to dependencies
- `src/changelog/writer.rs`: Added `atomic_write()` function for atomic file replacement
- `src/changelog/writer.rs`: Added `atomic_copy()` function for atomic backups
- `src/changelog/writer.rs`: Updated `write_changelog()` to use atomic operations
- `src/changelog/writer.rs`: Added 5 unit tests for atomic operations
- `src/main.rs`: Fixed `fetch_commits()` calls to include new `strict` parameter (pre-existing issue)
- `tests/fetch_commits_test.rs`: Fixed `fetch_commits()` calls to include new `strict` parameter

### Research Sources
- [tempfile crate - NamedTempFile documentation](https://docs.rs/tempfile/latest/tempfile/struct.NamedTempFile.html)
- [Cargo's flock.rs](https://github.com/rust-lang/cargo/blob/master/src/cargo/util/flock.rs)

### Testing
- [x] Build passes (`cargo build`)
- [x] Type checks pass (`cargo check`)
- [x] 104 unit tests pass (`cargo test`)
- [ ] Manual testing required

---
*Solved by Claude Code*
