---
id: "KRX-084"
title: "Add direct unit test for run_rg exit code 2+ error construction"
type: task
status: in-review
priority: high
labels: ["testing", "critical-gap"]
created: "2026-01-29"
updated: "2026-01-29"
assignee: jacksnxly
---

# Add direct unit test for run_rg exit code 2+ error construction

## Context
The `run_rg` function handles ripgrep exit code 2 and above as errors, returning `VerificationError::RipgrepFailed`. Exit code 2 from ripgrep indicates critical errors like malformed regex or permission denied. While downstream effects are tested in `verification_rg_error_test.rs`, the error variant construction itself is not directly tested.

Identified during PR review of feat/agentic-verification branch.

## Current State
- `run_rg` at `src/verification/scanner.rs:31-55` constructs `RipgrepFailed` errors
- The existing test `verification_rg_error_test.rs` tests the *downstream effect* (marking as incomplete)
- No test directly verifies `VerificationError::RipgrepFailed` is returned with correct `exit_code` and `stderr` fields

## Desired State
A direct unit test that verifies the `run_rg` function correctly constructs the `RipgrepFailed` error variant with proper field values when ripgrep exits with code 2 or higher.

## Acceptance Criteria
- [x] Test creates a mock rg that exits with code 2 and stderr message
- [x] Test verifies `VerificationError::RipgrepFailed` is returned
- [x] Test verifies `exit_code` field contains the correct value
- [x] Test verifies `stderr` field contains the error message

## Technical Notes
- Location: `src/verification/scanner.rs:31-55`, specifically lines 40-45
- Error type: `VerificationError::RipgrepFailed { exit_code: Option<i32>, stderr: String }`
- May require creating a mock script similar to `verification_rg_error_test.rs`
- Criticality: 9/10 (from PR review)

---

## Resolution

**Completed:** 2026-01-29

### Approach
Added 4 direct unit tests inside `scanner.rs` that use mock shell scripts to test the `run_rg` function's error handling behavior. Tests are Unix-only (`#[cfg(unix)]`) since they use shell scripts.

### Changes Made
- `src/verification/scanner.rs`:
  - Added `#[derive(Debug)]` to `RgOutcome` enum (required for test assertions)
  - Added 4 new unit tests:
    - `test_run_rg_exit_code_2_returns_ripgrep_failed` - verifies exit code 2 returns `RipgrepFailed` with correct fields
    - `test_run_rg_exit_code_3_returns_ripgrep_failed` - verifies exit code 3 also returns `RipgrepFailed`
    - `test_run_rg_exit_code_1_is_no_match` - confirms exit code 1 returns `Ok(NoMatch)` (boundary case)
    - `test_run_rg_success_returns_stdout` - confirms exit code 0 returns `Ok(Success(stdout))`

### Testing
- [x] Build passes (`cargo build`)
- [x] All 177 unit tests pass (`cargo test`)
- [x] Type checks pass (`cargo check`)
- [x] New tests specifically verify `exit_code` and `stderr` field values

---
*Solved by Claude Code*
