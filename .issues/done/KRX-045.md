---
id: "KRX-045"
title: "Add memory limit for PR pagination"
type: improvement
status: done
priority: medium
labels: ["performance", "error-handling"]
created: "2026-01-26"
updated: "2026-01-26"
assignee: null
---

# Add memory limit for PR pagination

## Problem
While there is a 50-page safety limit, the code fetches all PRs into memory. For very active repositories, this could be 5000+ PRs causing memory exhaustion.

## Current Behavior
```rust
let mut all_prs = Vec::new();
// ... loop fetching up to 50 pages * 100 PRs = 5000 PRs
```

All PRs loaded into memory at once.

## Expected Behavior
Either limit PR fetching more aggressively or use streaming/iterators to reduce memory footprint.

## Acceptance Criteria
- [x] PR fetching has reasonable memory bounds
- [x] Large repositories don't cause memory exhaustion
- [x] Consider date filtering to reduce initial fetch size

## Technical Notes
**File:** `src/github/prs.rs:74-184`

Options:
1. More aggressive date filtering (only fetch PRs since last tag)
2. Implement iterator/streaming for PR processing
3. Add configurable limit with sensible default
4. Warn if hitting page limit

---

## Resolution

**Completed:** 2026-01-26

### Approach
Implemented Option 3 (configurable limit with sensible default) with improved warning messages:
- Added `--pr-limit` / `-l` CLI flag (default: 100)
- Added `KERYX_PR_LIMIT` environment variable for power users
- Implemented early termination when PR limit is reached
- Improved warning messages for both PR limit and page limit

### Changes Made
- `src/github/prs.rs`: Added `DEFAULT_PR_LIMIT` (100), `PR_LIMIT_ENV_VAR`, `get_pr_limit()` helper, and limit parameter to `fetch_merged_prs` / `fetch_merged_prs_with_client`
- `src/main.rs`: Added `--pr-limit` CLI argument, propagated through `run_init`, `run_init_unreleased`, `run_init_from_history`, `run_generate`, and `fetch_prs_for_repo`
- `tests/github_prs_test.rs`: Updated all tests with limit parameter, added 4 new tests for limit functionality

### Research Sources
- GitHub REST API Best Practices (pagination, rate limiting)
- Octocrab documentation (Page struct, pagination)
- git-cliff, release-please, GitHub CLI (industry standard limits: 30-100)

### Testing
- [x] Build passes (debug and release)
- [x] 208 tests pass (including 21 GitHub PR tests, 4 new limit tests, 5 new config tests)
- [x] Clippy passes with no warnings
- [x] CLI help shows new `--pr-limit` option

---
*Solved by Claude Code*
