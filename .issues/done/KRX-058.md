# [KRX-058] Add debug logging for silent fallbacks in verification scanner

**Type:** improvement
**Priority:** medium
**Status:** done
**Labels:** error-handling, silent-failure, ux
**Created:** 2026-01-27
**Updated:** 2026-01-27
**Branch:** feat/agentic-verification

---

## Problem

Several functions in the verification scanner silently fall back or skip operations without logging, making debugging difficult when verification evidence is incomplete.

## Current Behavior

Silent failures occur in:

1. **`get_project_structure()`** (scanner.rs:785-798)
   - Falls back from `tree` to `ls -la` without logging
   - Returns `None` if `ls` also fails, with no indication why

2. **`gather_key_files()`** (scanner.rs:817)
   - Silently skips files that exist but can't be read (permission denied, I/O error)

3. **`search_and_count_array()`** (scanner.rs:633)
   - File read errors ignored when counting array elements

4. **Stub detection** (scanner.rs:421-442)
   - Non-success exit codes (other than 1) not logged

## Expected Behavior

Debug/warn logging should indicate when fallback paths are taken or operations fail, so users running with `--verbose` can understand why verification evidence is incomplete.

## Acceptance Criteria

- [x] `get_project_structure()` logs when `tree` fails and falls back to `ls`
- [x] `get_project_structure()` logs when both `tree` and `ls` fail
- [x] `gather_key_files()` warns when a file exists but can't be read
- [x] `search_and_count_array()` logs file read failures at debug level
- [x] Stub detection logs ripgrep errors (exit code != 0 and != 1)

## Technical Notes

**Locations:**
- `src/verification/scanner.rs:785-798` (get_project_structure)
- `src/verification/scanner.rs:817` (gather_key_files)
- `src/verification/scanner.rs:633` (search_and_count_array)
- `src/verification/scanner.rs:421-442` (stub detection)

**Example fix for get_project_structure:**
```rust
match output {
    Ok(out) if out.status.success() => { /* ... */ }
    Ok(out) => {
        debug!("tree command failed (exit code {:?}), falling back to ls", out.status.code());
        // fallback...
    }
    Err(e) if e.kind() == std::io::ErrorKind::NotFound => {
        debug!("tree command not found, falling back to ls");
        // fallback...
    }
    Err(e) => {
        warn!("tree command error: {}, falling back to ls", e);
        // fallback...
    }
}
```

---
*Created from PR review of feat/agentic-verification*

---

## Resolution

**Completed:** 2026-01-27

### Approach
Added debug/warn logging to all four silent fallback locations in the verification scanner. Used `debug!` level for expected fallbacks (like tree not found) and `warn!` level for unexpected failures (like permission denied on key files).

### Changes Made
- `src/verification/scanner.rs:778-842`: Expanded `get_project_structure()` match to handle all cases with appropriate logging for tree failures, ls fallback, and when both fail
- `src/verification/scanner.rs:857-885`: Changed `gather_key_files()` to use `match` instead of `if let Ok` to warn when files exist but cannot be read
- `src/verification/scanner.rs:630-648`: Added debug logging in `search_and_count_array()` when file read fails for array counting
- `src/verification/scanner.rs:416-458`: Expanded stub detection inner rg call to log when exit code is not 0 or 1, and when command execution fails

### Testing
- [x] Build passes (`cargo build`)
- [x] 151 unit tests pass (`cargo test`)
- [ ] Manual testing with `--verbose` flag recommended

---
*Solved by Claude Code*
