---
id: "KRX-100"
title: "Collect all group diffs upfront in run_split_commits"
type: bug
status: done
priority: medium
labels: ["bug", "code-quality"]
created: "2026-02-02"
updated: "2026-02-02"
assignee: null
---

# Collect all group diffs upfront in run_split_commits

## Problem
In `run_split_commits`, `collect_diff_for_paths` is called inside the loop after previous groups have already been committed. Since `stage_paths_and_commit` advances HEAD, the diff context seen by subsequent groups may drift from the original state. The commit itself is correct (uses pre-computed `file_statuses` map), but the LLM prompt for group N+1 may contain inaccurate diff text.

## Current Behavior
```
for group in groups:
    diff = collect_diff_for_paths(repo, group.files)  // HEAD has shifted!
    message = generate_commit_message(diff, ...)
    stage_paths_and_commit(...)  // advances HEAD
```

After committing group 1, `collect_diff_for_paths` for group 2 sees a different HEAD. For modified (already-tracked) files, the diff context may be inaccurate.

## Expected Behavior
All group diffs should be collected before any commits are made:
```
diffs = [collect_diff_for_paths(repo, g.files) for g in groups]
for (group, diff) in zip(groups, diffs):
    message = generate_commit_message(diff, ...)
    stage_paths_and_commit(...)
```

## Acceptance Criteria
- [ ] All group diffs are collected before any commit is made
- [ ] LLM receives accurate diff text for all groups
- [ ] Sequential multi-commit test still passes
- [ ] No regression in single-commit path

## Technical Notes
- File: `src/main.rs`, `run_split_commits` function (lines ~937-976)
- The actual staging/committing is correct (uses `file_statuses` from original diff)
- Only the LLM prompt accuracy is affected, not commit correctness
- Found during PR review of `feat/commit-messages`

---

## Resolution

**Completed:** 2026-02-02

### Approach
Moved all `collect_diff_for_paths` calls out of the commit loop into a pre-collection phase. All group diffs are now gathered into a `Vec<DiffSummary>` before any commits advance HEAD, then the commit loop zips groups with their pre-collected diffs.

### Changes Made
- `src/main.rs`: Added `DiffSummary` to import from `keryx::commit`
- `src/main.rs`: Added upfront diff collection loop before the commit loop (lines ~938-947)
- `src/main.rs`: Changed commit loop to `analysis.groups.iter().zip(group_diffs.iter())` instead of calling `collect_diff_for_paths` inside the loop

### Testing
- [x] Build passes (`cargo build` -- clean compilation)
- [x] No regressions introduced by this change (2 pre-existing test failures from unrelated `serde(rename_all)` change)
- [x] Single-commit path unaffected (only `run_split_commits` modified)

---
*Solved by Claude Code*
