---
id: "KRX-095"
title: "Fix silent .ok() discarding diff print errors in append_diff_text"
type: bug
status: done
priority: high
labels: ["silent-failure", "error-handling", "critical-gap"]
created: "2026-02-02"
updated: "2026-02-02"
assignee: null
---

# Fix silent .ok() discarding diff print errors in append_diff_text

## Problem
`append_diff_text` calls `diff.print(...).ok()` which silently discards any `git2::Error`. If the print fails (corrupt objects, I/O errors, memory allocation), `diff_text` will be empty or partial, and `additions`/`deletions` counts will be wrong.

## Current Behavior
Errors from `diff.print(DiffFormat::Patch, ...)` are silently swallowed by `.ok()`. The LLM receives incomplete or empty diff text with no indication of failure, generating commit messages based on wrong data.

## Expected Behavior
Diff print errors should be logged and the `truncated` flag should be set, or the error should propagate. The user should be informed if the diff is incomplete.

## Steps to Reproduce
1. Create a scenario where `diff.print()` fails (e.g., corrupt git objects)
2. Run `keryx commit`
3. Observe that the commit message is generated from empty/partial diff with no warning

## Acceptance Criteria
- [ ] `diff.print()` errors are handled (logged + truncated flag, or propagated)
- [ ] User sees a warning if diff text could not be fully collected
- [ ] Existing tests continue to pass

## Technical Notes
- File: `src/commit/diff.rs`, line 237-238 (in `append_diff_text`)
- Suggested fix: `.unwrap_or_else(|e| { tracing::warn!(...); *truncated = true; })`
- Found during PR review of `feat/commit-messages`

---

## Resolution

**Completed:** 2026-02-02

### Approach
Replaced the silent `.ok()` call with an idiomatic `if let Err(e)` pattern that logs the error at `warn` level via `tracing::warn!` and sets `*truncated = true` so downstream consumers know the diff data may be incomplete. This is a non-fatal degradation — the tool can still generate a commit message from partial diff text plus the `changed_files` list.

### Changes Made
- `src/commit/diff.rs`: Added `use tracing::warn;` import (line 6). Replaced `.ok()` on `diff.print()` result with `if let Err(e) { warn!(...); *truncated = true; }` (lines 200-230).

### Research Sources
- [Diff in git2 — docs.rs](https://docs.rs/git2/latest/git2/struct.Diff.html)
- [Error Handling in Rust — Andrew Gallant (burntsushi)](https://burntsushi.net/rust-error-handling/)
- [Recoverable Errors with Result — The Rust Book](https://doc.rust-lang.org/book/ch09-02-recoverable-errors-with-result.html)

### Testing
- [x] Build passes (`cargo build` — 0 errors, 0 warnings)
- [x] All 398 tests pass (`cargo test` — 0 failures)
- [ ] Manual testing required

---
*Solved by Claude Code*
