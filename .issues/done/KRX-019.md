---
id: "KRX-019"
title: "Add logging when fallback timestamps are used for commits"
type: bug
status: done
priority: high
labels: ["silent-failure", "error-handling", "ux"]
created: "2026-01-25"
updated: "2026-01-25"
assignee: null
---

# Add logging when fallback timestamps are used for commits

## Problem
When a git commit has an invalid or corrupt timestamp, the code silently replaces it with `Utc::now()`. Users never know that commit timestamps in their changelog data are fabricated, which can cause commits to appear in the wrong order or affect version calculations.

## Current Behavior
```rust
let timestamp = Utc
    .timestamp_opt(time.seconds(), 0)
    .single()
    .unwrap_or_else(Utc::now);
```

Silent fallback to current time - no logging, no warning, no indication to the user.

## Expected Behavior
When a fallback timestamp is used:
1. Log a warning with the commit hash
2. In verbose mode, show the original invalid timestamp value
3. Consider adding a CLI flag to fail on invalid timestamps (strict mode)

## Steps to Reproduce
1. Have a repository with a commit that has a corrupt timestamp (rare but possible)
2. Run keryx to generate changelog
3. Observe no warning about the invalid timestamp
4. Wonder why commit ordering seems wrong

**Environment:** Repositories with corrupt git data or unusual timezone handling

## Acceptance Criteria
- [x] Warning logged when fallback timestamp is used
- [x] Warning includes commit hash for traceability
- [x] Warning includes original timestamp value (if available) in verbose mode
- [ ] Consider `--strict` flag to fail instead of fallback

## Technical Notes
**File:** `src/git/commits.rs:62-65`

**Recommended fix:**
```rust
let timestamp = match Utc.timestamp_opt(time.seconds(), 0).single() {
    Some(ts) => ts,
    None => {
        warn!(
            "Commit {} has invalid timestamp (seconds={}), using current time as fallback",
            commit.id(),
            time.seconds()
        );
        Utc::now()
    }
};
```

**Hidden errors this would expose:**
- Corrupted git repository timestamps
- Time zone conversion issues
- Commits with timestamps before Unix epoch
- Clock skew from distributed systems

**Related issues:**
- Similar silent fallback patterns exist for:
  - Non-UTF8 tag names (`src/git/tags.rs:33-56`)
  - Empty commit messages (`src/git/commits.rs:60`)

---

## Resolution

**Completed:** 2026-01-25

### Approach
Implemented the recommended fix from the issue - replaced the silent `unwrap_or_else` with explicit pattern matching that logs a warning when the fallback is used.

### Changes Made
- `src/git/commits.rs`: Added `tracing::warn` import and replaced silent fallback with warning log that includes commit hash and original timestamp seconds value

### Research Sources
- Existing codebase patterns (see `src/git/range.rs` for similar warning usage)

### Testing
- [x] Build passes (`cargo build --release`)
- [x] Type checks pass (`cargo check`)
- [x] All 146 tests pass (`cargo test`)
- [ ] Manual testing required (needs repository with corrupt timestamp)

### Notes
The `--strict` flag mentioned in acceptance criteria was marked as "Consider" and is left for a future enhancement. The core fix (warning logging) has been implemented.

---
*Solved by Claude Code*
