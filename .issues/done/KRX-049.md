# [KRX-049] Add prerequisite check for ripgrep before verification

**Type:** bug
**Priority:** high
**Status:** done
**Updated:** 2026-01-27
**Labels:** error-handling, silent-failure, ux
**Created:** 2026-01-26
**Branch:** feat/agentic-verification

---

## Problem

The verification module requires `rg` (ripgrep) to function, but there's no upfront check. If ripgrep is not installed, all keyword searches silently return `None`, causing meaningless verification results.

## Current Behavior

```rust
fn search_keyword(keyword: &str, repo_path: &Path) -> Option<SearchResult> {
    let output = Command::new("rg")
        .args([...])
        .output();

    match output {
        Ok(out) if out.status.success() => { ... }
        _ => return None,  // Silent failure!
    };
```

Users without ripgrep get:
- All keyword searches return no matches
- All entries marked as "low confidence"
- Verification appears to work but produces meaningless results
- No error message explaining what's wrong

## Expected Behavior

Similar to `check_claude_installed()`, verification should:
1. Check if `rg` is available before starting
2. Fail fast with a clear error message if not installed
3. Provide installation instructions

## Acceptance Criteria

- [x] Add `check_ripgrep_installed()` function
- [x] Call it at the start of `verify_changelog_entries()`
- [x] Error message includes installation instructions (e.g., `cargo install ripgrep` or `brew install ripgrep`)
- [x] User can bypass with `--no-verify` if they don't want to install ripgrep

## Technical Notes

**Model after:** `src/claude/subprocess.rs` - `check_claude_installed()`

**Suggested implementation:**
```rust
pub async fn check_ripgrep_installed() -> Result<()> {
    let output = Command::new("rg")
        .arg("--version")
        .output();

    match output {
        Ok(out) if out.status.success() => Ok(()),
        _ => Err(anyhow!(
            "ripgrep (rg) is required for verification but was not found.\n\
             Install with: cargo install ripgrep\n\
             Or skip verification with: --no-verify"
        )),
    }
}
```

---

## Resolution

**Completed:** 2026-01-27

### Approach

Added a typed `VerificationError::RipgrepNotInstalled` error and a `check_ripgrep_installed()` function that runs `rg --version` to verify ripgrep is available. The check is called at the start of `verify_changelog_entries()` before any verification work begins.

### Changes Made

- `src/error.rs`: Added `VerificationError` enum with `RipgrepNotInstalled` variant containing platform-specific installation instructions
- `src/lib.rs`: Exported `VerificationError` from the crate
- `src/verification/mod.rs`: Added `check_ripgrep_installed()` function using synchronous `std::process::Command`
- `src/main.rs`: Import and call `check_ripgrep_installed()` at start of `verify_changelog_entries()`

### Research Sources

- [Command Line Applications in Rust - Error Handling](https://rust-cli.github.io/book/tutorial/errors.html)
- [which crate documentation](https://docs.rs/which)
- [Command Line Interface Guidelines](https://clig.dev/)

### Testing

- [x] Build passes (`cargo build`)
- [x] All 119 tests pass (`cargo test`)
- [x] `--no-verify` flag bypasses the check (existing behavior)

---
*Solved by Claude Code*
