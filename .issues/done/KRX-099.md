---
id: "KRX-099"
title: "Replace changelog_category String with ChangelogCategory enum"
type: improvement
status: done
priority: medium
labels: ["code-quality", "error-handling"]
created: "2026-02-02"
updated: "2026-02-02"
assignee: null
---

# Replace changelog_category String with ChangelogCategory enum

## Context
`CommitMessage::changelog_category` is `Option<String>` but the valid values are a fixed set: "added", "changed", "fixed", "removed", "deprecated", "security". An LLM hallucinating an invalid category (e.g., "enhanced") would silently produce a bad `Changelog:` trailer in the commit, breaking downstream changelog tooling.

## Current Implementation
```rust
pub struct CommitMessage {
    pub changelog_category: Option<String>,     // any string accepted
    pub changelog_description: Option<String>,  // can be inconsistent with category
}
```

The `format()` method blindly writes whatever string the LLM returns. The category/description pairing invariant (both `Some` or both `None`) is not enforced.

## Proposed Improvement
1. Create a `ChangelogCategory` enum with `#[serde(rename_all = "lowercase")]`:
   ```rust
   enum ChangelogCategory { Added, Changed, Fixed, Removed, Deprecated, Security }
   ```
2. Replace `changelog_category: Option<String>` with `Option<ChangelogCategory>`
3. Consider pairing category + description into `Option<ChangelogEntry>` to make invalid states unrepresentable
4. Invalid LLM categories will fail at deserialization and hit the existing error path

## Acceptance Criteria
- [ ] `ChangelogCategory` enum exists with the 6 valid variants
- [ ] `CommitMessage` uses `Option<ChangelogCategory>` instead of `Option<String>`
- [ ] Invalid categories from LLM fail at deserialization (not silently accepted)
- [ ] `format()` and `is_user_facing()` work with the enum
- [ ] Existing formatting tests pass (update as needed)

## Technical Notes
- File: `src/commit/message.rs`
- Use `#[serde(rename_all = "lowercase")]` for JSON deserialization compatibility
- Optionally combine into `Option<ChangelogEntry { category, description }>` to enforce the both-or-neither invariant
- Found during PR review of `feat/commit-messages`

---

## Resolution

**Completed:** 2026-02-02

### Approach
Reused the existing `ChangelogCategory` enum from `src/changelog/format.rs` in the `CommitMessage` struct, replacing the `Option<String>` with `Option<ChangelogCategory>`. Added a custom serde `Deserialize` implementation that delegates to the existing case-insensitive `FromStr` impl, so both `"Added"` (from changelog LLM) and `"added"` (from commit LLM) deserialize correctly. Serialization uses `#[serde(rename_all = "lowercase")]` to always produce lowercase output. Invalid categories now fail at deserialization rather than silently producing bad trailers.

### Changes Made
- `src/changelog/format.rs`: Added `#[serde(rename_all = "lowercase")]` for serialization; replaced derived `Deserialize` with custom case-insensitive impl using `FromStr`
- `src/commit/message.rs`: Changed `changelog_category: Option<String>` to `Option<ChangelogCategory>`; updated `format()` to use `cat.as_str().to_lowercase()`; updated all tests to use enum variants; added `test_commit_message_deserialize_invalid_category_fails`
- `src/main.rs`: Updated `display_commit_message()` to use `cat.as_str().to_lowercase()`

### Research Sources
- Existing `ChangelogCategory` enum and `FromStr` impl in codebase

### Testing
- [x] Build passes (`cargo build`)
- [x] All 293 unit tests pass (`cargo test`)
- [x] Invalid category deserialization correctly fails (new test)
- [x] Existing changelog pipeline tests pass (case-insensitive deserialization)
- [ ] Manual testing required

---
*Solved by Claude Code*
