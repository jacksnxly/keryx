---
id: "KRX-074"
title: "Fix count verification failure defaulting to matches=true"
type: bug
status: in-review
priority: urgent
labels: ["bug", "silent-failure", "critical-gap"]
created: "2026-01-27"
updated: "2026-01-27"
assignee: null
---

# Fix count verification failure defaulting to matches=true

## Problem
`CountCheck::matches()` returns `true` when `actual_count` is `None` (i.e., when count verification failed for any reason). This means a changelog entry claiming "added 100 templates" is marked as "verified matching" if the counting operation fails, even if zero templates exist.

The `count_files_matching` and `search_and_count_array` functions both return `None` on all error paths. Combined with the `matches() -> true` default, any count verification failure silently validates the claim.

## Current Behavior
```rust
pub fn matches(&self) -> bool {
    match (self.claimed_count, self.actual_count) {
        (Some(claimed), Some(actual)) => claimed == actual,
        _ => true, // Unknown actual count = assume match
    }
}
```

When count verification fails (rg error, `find` error, permission denied), `actual_count` is `None` and `matches()` returns `true`.

## Expected Behavior
When count verification cannot determine the truth, the result should indicate "could not verify" rather than "verified as matching."

## Acceptance Criteria
- [x] `CountCheck::matches()` returns `Option<bool>` where `None` = "could not verify"
- [x] Update callers to handle `None` (could-not-verify) case appropriately
- [x] Update custom `Serialize` impl to serialize the new semantics
- [x] Update confidence scoring to account for unverifiable counts
- [x] Existing tests updated for new return type

## Technical Notes
- **File:** `src/verification/evidence.rs:155-160` (`matches()` method)
- **Related:** `src/verification/scanner.rs:543-663` (`count_files_matching`, `search_and_count_array` return `None` on errors)
- **Related:** `src/verification/scanner.rs:507` (`try_verify_count` returns `(None, None)` on failure)
- Also consider changing `occurrence_count: usize` to `Option<usize>` in `KeywordMatch` to preserve the "counting failed" vs "counted zero" distinction (currently collapsed via `unwrap_or(0)` at scanner.rs:114)

---

## Resolution

**Completed:** 2026-01-27

### Approach
Changed `CountCheck::matches()` from returning `bool` to `Option<bool>`:
- `Some(true)` - counts were verified and match
- `Some(false)` - counts were verified and don't match
- `None` - could not verify (either claimed or actual count is unknown)

This fixes the silent failure where unverifiable claims were incorrectly marked as "verified matching."

### Changes Made
- `src/verification/evidence.rs`: Updated `matches()` return type to `Option<bool>`, updated confidence scoring to penalize unverifiable counts (-10 penalty vs -20 for mismatches), updated Serialize impl
- `src/main.rs`: Updated caller to handle `Option<bool>` with match expression, now displays "Could not verify" message for unverifiable counts

### Testing
- [x] 168 unit tests pass
- [x] 5 main.rs tests pass
- [x] All integration tests pass
- [x] Build succeeds

### New Behavior
- Verified match: no penalty to confidence score
- Verified mismatch: -20 penalty (unchanged)
- Could not verify: -10 penalty (previously: no penalty, incorrectly treated as verified match)
- JSON serialization: `"matches": null` for unverifiable (previously: `"matches": true`)

---
*Solved by Claude Code*
