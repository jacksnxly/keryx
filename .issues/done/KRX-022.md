---
id: "KRX-022"
title: "Fix silent fallback on annotated tag resolution failure"
type: bug
status: done
priority: urgent
labels: ["silent-failure", "error-handling", "critical-gap"]
created: "2026-01-26"
updated: "2026-01-26"
resolved: "2026-01-26"
assignee: null
---

# Fix silent fallback on annotated tag resolution failure

## Problem
When an annotated tag cannot be resolved (corrupted repo, permissions issue), the code silently falls back to using the raw OID. This hides the fact that tag resolution failed and could associate the wrong commit with a tag.

## Current Behavior
In `src/git/tags.rs:44-48`:

```rust
let resolved_oid = if let Ok(tag_obj) = repo.find_tag(oid) {
    tag_obj.target_id()
} else {
    oid  // Silent fallback - no indication of failure
};
```

## Expected Behavior
Log when tag resolution falls back to distinguish between lightweight tags (expected) and failed resolution (unexpected).

## Steps to Reproduce
1. Create a repo with corrupted tag objects
2. Run keryx
3. Observe wrong commits being associated with tags without warning

**Environment:** All platforms

## Acceptance Criteria
- [ ] Debug log when tag resolution falls back (distinguishes lightweight tags from failures)
- [ ] Log includes tag name and error reason
- [ ] Normal lightweight tag handling still works silently

## Technical Notes
**File:** `src/git/tags.rs:44-48`

Suggested fix:
```rust
let resolved_oid = match repo.find_tag(oid) {
    Ok(tag_obj) => tag_obj.target_id(),
    Err(e) => {
        tracing::debug!(
            "Could not resolve annotated tag {} ({}), using raw OID. \
             This is normal for lightweight tags.",
            name, e
        );
        oid
    }
};
```

---

## Resolution

**Completed:** 2026-01-26

### Approach
Replaced the silent `if let Ok` fallback with a `match` expression that logs a debug message when tag resolution fails. The debug log includes the tag name and error reason using tracing's structured logging format.

### Changes Made
- `src/git/tags.rs:5`: Added `debug` to tracing import
- `src/git/tags.rs:44-56`: Changed `if let Ok` to `match` with debug logging in the `Err` branch

### Implementation
```rust
// Resolve tag to commit (handle annotated tags)
let resolved_oid = match repo.find_tag(oid) {
    Ok(tag_obj) => tag_obj.target_id(),
    Err(e) => {
        debug!(
            tag = %name,
            error = %e,
            "Could not resolve annotated tag, using raw OID. \
             This is normal for lightweight tags."
        );
        oid
    }
};
```

### Testing
- [x] Build passes (`cargo check`)
- [x] All 146 tests pass (`cargo test`)
- [x] Lightweight tags continue to work without visible output (debug level only)

---
*Solved by Claude Code*
