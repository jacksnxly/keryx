---
id: "KRX-027"
title: "Add debug logging for gh CLI auth failure chain"
type: improvement
status: done
priority: high
labels: ["error-handling", "ux"]
created: "2026-01-26"
updated: "2026-01-26"
assignee: null
---

# Add debug logging for gh CLI auth failure chain

## Context
The `get_token_from_gh_cli()` function has multiple `.ok()?` calls that convert errors into `None` without any logging. Users have no visibility into why gh CLI auth failed when troubleshooting authentication issues.

## Current Implementation
In `src/github/auth.rs:53-78`:

```rust
fn get_token_from_gh_cli() -> Option<String> {
    let status = Command::new("gh")
        .args(["auth", "status"])
        .output()
        .ok()?;  // Silent failure

    if !status.status.success() {
        return None;  // Silent failure
    }

    let output = Command::new("gh")
        .args(["auth", "token"])
        .output()
        .ok()?;  // Silent failure
    // ...
}
```

## Proposed Improvement
Add debug logging for each potential failure point so users can diagnose auth issues with `--verbose`.

## Acceptance Criteria
- [ ] Debug log when `gh` command fails to execute
- [ ] Debug log when `gh auth status` fails (with stderr)
- [ ] Debug log when `gh auth token` fails (with stderr)
- [ ] Users can diagnose auth issues using `--verbose`

## Technical Notes
**File:** `src/github/auth.rs:53-78`

Suggested fix:
```rust
fn get_token_from_gh_cli() -> Option<String> {
    let status = match Command::new("gh").args(["auth", "status"]).output() {
        Ok(s) => s,
        Err(e) => {
            tracing::debug!("gh CLI not available or failed to execute: {}", e);
            return None;
        }
    };

    if !status.status.success() {
        tracing::debug!(
            "gh auth status failed: {}",
            String::from_utf8_lossy(&status.stderr)
        );
        return None;
    }
    // ... similar for auth token
}
```

---

## Resolution

**Completed:** 2026-01-26

### Approach
Replaced silent `.ok()?` calls with explicit `match` statements that log debug messages before returning `None`. Added debug logging at all 5 potential failure points in the auth chain.

### Changes Made
- `src/github/auth.rs:53-94`: Rewrote `get_token_from_gh_cli()` to use explicit match statements with `tracing::debug!` logging:
  1. Log when `gh auth status` command fails to execute (e.g., gh CLI not installed)
  2. Log when `gh auth status` returns non-zero exit code (with stderr)
  3. Log when `gh auth token` command fails to execute
  4. Log when `gh auth token` returns non-zero exit code (with stderr)
  5. Log when `gh auth token` returns empty output

### Acceptance Criteria Verification
- [x] Debug log when `gh` command fails to execute
- [x] Debug log when `gh auth status` fails (with stderr)
- [x] Debug log when `gh auth token` fails (with stderr)
- [x] Users can diagnose auth issues using `--verbose`

### Testing
- [x] Build passes (`cargo build`)
- [x] All 75 tests pass (`cargo test`)
- [ ] Manual testing with `--verbose` flag

---
*Solved by Claude Code*
