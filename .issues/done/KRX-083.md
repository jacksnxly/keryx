---
id: "KRX-083"
title: "Add unit tests for check_ripgrep_installed function"
type: task
status: in-review
priority: high
labels: ["testing", "critical-gap"]
created: "2026-01-29"
updated: "2026-01-29"
assignee: null
---

# Add unit tests for check_ripgrep_installed function

## Context
The `check_ripgrep_installed()` function is the public gate function that determines whether verification can proceed. It's called before any verification runs and returns different error types based on whether ripgrep is missing vs. broken. Without test coverage, incorrect behavior could cause confusing errors for users.

Identified during PR review of feat/agentic-verification branch.

## Current State
The function at `src/verification/mod.rs:20-39` has no unit tests. It handles three scenarios:
1. Ripgrep available and working → returns `Ok(())`
2. Ripgrep not installed → returns `RipgrepNotInstalled` error
3. Ripgrep installed but broken → returns `RipgrepFailed` error

## Desired State
Comprehensive unit tests covering all three code paths to ensure:
- Success case is correctly identified
- Missing ripgrep returns the correct error type
- Broken ripgrep returns the correct error type with proper details

## Acceptance Criteria
- [x] Test `check_ripgrep_installed` returns `Ok(())` when rg is available
- [x] Test returns `RipgrepNotInstalled` error when rg binary not found
- [x] Test returns `RipgrepFailed` error for broken rg installation
- [x] Tests use mocking or PATH manipulation to simulate missing/broken rg

## Technical Notes
- Location: `src/verification/mod.rs:20-39`
- Related: `VerificationError` enum in `src/error.rs:103-131`
- May need Unix-specific test gating similar to `verification_rg_error_test.rs`
- Criticality: 8/10 (from PR review)

---

## Resolution

**Completed:** 2026-01-29

### Approach
Created a new integration test file with three test cases covering all code paths in `check_ripgrep_installed()`. Tests use PATH environment variable manipulation with fake shell scripts to simulate different ripgrep states, following the established pattern from `verification_rg_error_test.rs`.

### Changes Made
- `tests/check_ripgrep_test.rs`: New test file with 3 tests
  - `test_check_ripgrep_installed_success` - fake rg script returns success
  - `test_check_ripgrep_not_installed` - empty PATH, no rg binary
  - `test_check_ripgrep_failed` - fake rg script exits with error code 2
- `tests/verification_rg_error_test.rs`: Added `#[serial]` attribute to prevent race conditions
- `Cargo.toml`: Added `serial_test = "3"` dev dependency for thread-safe test execution

### Technical Details
- Tests are Unix-only (`#![cfg(unix)]`) since they use shell scripts
- Feature-gated with `#[cfg_attr(not(feature = "rg-tests"), ignore)]` for CI flexibility
- Uses `#[serial]` from `serial_test` crate to prevent PATH race conditions when tests run in parallel

### Testing
- [x] Build passes (`cargo build`)
- [x] All 3 new tests pass
- [x] Full test suite passes (201 tests)
- [x] Tests run correctly with parallel execution (serial_test prevents race conditions)

---
*Solved by Claude Code*
