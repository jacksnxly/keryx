# [KRX-053] Optimize stub detection to reduce subprocess spawning

**Type:** improvement
**Priority:** medium
**Status:** done
**Labels:** performance
**Created:** 2026-01-26
**Branch:** feat/agentic-verification

---

## Problem

The `find_stub_indicators_near_keyword` function spawns a separate ripgrep process for each stub pattern, for each file. With 12 stub patterns and up to 5 files per keyword, this can spawn up to 60 subprocesses per keyword.

## Current Behavior

```rust
// STUB_PATTERNS has 12 entries
const STUB_PATTERNS: &[&str] = &[
    "TODO", "FIXME", "XXX", "HACK", "unimplemented!", "todo!",
    "panic!(\"not implemented", "panic!(\"unimplemented",
    "// stub", "// placeholder", "NotImplemented", "raise NotImplementedError",
];

fn find_stub_indicators_near_keyword(keyword: &str, repo_path: &Path) -> Vec<StubIndicator> {
    // For each file (up to 5)
    for file in files {
        // For each pattern (12 patterns)
        for pattern in STUB_PATTERNS {
            let output = Command::new("rg")  // Spawns subprocess
                .args([...pattern...])
```

For a changelog with 10 entries and 5 keywords each, this could spawn:
`10 entries × 5 keywords × 5 files × 12 patterns = 3000 subprocesses`

## Expected Behavior

Combine patterns into a single ripgrep call using alternation, reducing subprocess count by 12x.

## Acceptance Criteria

- [x] Combine `STUB_PATTERNS` into single regex alternation pattern
- [x] Single ripgrep call per file instead of 12
- [x] Subprocess count reduced by ~90%
- [x] Same detection accuracy

## Technical Notes

**Location:** `src/verification/scanner.rs:277-336`

**Fix:**
```rust
lazy_static! {
    static ref STUB_PATTERN: String = STUB_PATTERNS
        .iter()
        .map(|p| regex::escape(p))
        .collect::<Vec<_>>()
        .join("|");
}

fn find_stub_indicators_near_keyword(keyword: &str, repo_path: &Path) -> Vec<StubIndicator> {
    // ...
    for file in files {
        // Single rg call with combined pattern
        let output = Command::new("rg")
            .args([
                "--line-number",
                "--max-count", "10",
                "-C", "1",
                &*STUB_PATTERN,  // Combined pattern
                &file,
            ])
            .current_dir(repo_path)
            .output();

        // Parse output and determine which pattern matched
        // ...
    }
}
```

**Alternative:** Use `-e` flag for multiple patterns in single call:
```bash
rg -e "TODO" -e "FIXME" -e "XXX" file.rs
```

---

## Resolution

**Completed:** 2026-01-27

### Approach
Used the `-e` flag alternative to combine all 12 stub patterns into a single ripgrep call per file. This eliminates the inner loop over patterns and reduces subprocess count from 60 (5 files × 12 patterns) to 5 (1 per file) per keyword.

### Changes Made
- `src/verification/scanner.rs`: Refactored `find_stub_indicators_near_keyword` function (lines 341-431) to use a single `rg` call with multiple `-e` flags instead of looping over patterns

### Implementation Details
- Build args vector dynamically with all 12 patterns using `-e` flag
- Increased `--max-count` to 36 (3 per pattern × 12 patterns) to maintain same detection depth
- Determine which pattern matched by checking the output context against `STUB_PATTERNS`
- Maintains same detection accuracy while reducing subprocess spawning by ~92%

### Testing
- [x] Build passes (`cargo build`)
- [x] All 119 tests pass (`cargo test`)
- [x] Clippy passes (18 style warnings, no errors)

---
*Solved by Claude Code*
