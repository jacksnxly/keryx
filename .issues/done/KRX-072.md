---
id: "KRX-072"
title: "Fix char_indices panic bug in count_array_elements"
type: bug
status: in-review
priority: urgent
labels: ["bug", "critical-gap"]
created: "2026-01-27"
updated: "2026-01-27"
assignee: null
---

# Fix char_indices panic bug in count_array_elements

## Problem
`count_array_elements` in `scanner.rs:688` uses `content[start..].chars().enumerate()` and treats the iterator index `i` as a byte offset. However, `.chars().enumerate()` yields character indices (0th char, 1st char, etc.), not byte offsets. For multi-byte UTF-8 content, `end = start + i` produces an incorrect byte offset, and the subsequent slice `content[start + 1..end]` at line 707 can **panic** at runtime.

## Current Behavior
If content between `start` and the closing bracket contains multi-byte UTF-8 characters (e.g., comments with non-ASCII text, string literals with Unicode), the computed offset falls in the middle of a multi-byte character, causing a panic or incorrect array element counting.

## Expected Behavior
The function should use byte offsets when indexing into the string, producing correct results regardless of character encoding.

## Steps to Reproduce
1. Create a source file with an array definition containing multi-byte characters (e.g., CJK characters in comments)
2. Run verification on a changelog entry that triggers `count_array_elements` on that file
3. Observe panic on slice operation

## Acceptance Criteria
- [x] Replace `.chars().enumerate()` with `.char_indices()` at `scanner.rs:688`
- [x] Add a unit test with multi-byte content in array definitions
- [x] All existing `count_array_elements` tests continue to pass

## Technical Notes
- **File:** `src/verification/scanner.rs:688`
- **Fix:** Change `for (i, c) in content[start..].chars().enumerate()` to `for (i, c) in content[start..].char_indices()`
- `.char_indices()` returns byte offsets relative to the slice, which is what the code expects
- The rest of the codebase handles UTF-8 boundaries correctly (e.g., `gather_key_files` at line 820)

---

## Resolution

**Completed:** 2026-01-27

### Approach
Replaced `.chars().enumerate()` with `.char_indices()` so that the loop variable `i` is a byte offset (not a character index), matching how it's used to slice `content`.

### Changes Made
- `src/verification/scanner.rs:688`: Changed `content[start..].chars().enumerate()` to `content[start..].char_indices()`
- `src/verification/scanner.rs` (tests): Added `test_count_array_elements_multibyte_utf8` and `test_count_array_elements_multibyte_utf8_multiline` tests with CJK, Cyrillic, and Japanese characters

### Testing
- [x] Build passes
- [x] All 167 unit tests pass
- [x] All 86 integration tests pass (14 ignored - require ripgrep)
- [x] Both new multi-byte UTF-8 tests pass
- [x] All 14 count_array_elements tests pass

---
*Solved by Claude Code*
