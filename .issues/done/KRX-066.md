---
id: "KRX-066"
title: "Add samples_available field to distinguish empty from failed sampling"
type: improvement
status: done
priority: high
labels: ["error-handling", "silent-failure"]
created: "2026-01-27"
updated: "2026-01-27"
resolved: "2026-01-27"
assignee: null
---

# Add samples_available field to distinguish empty from failed sampling

## Context
When fetching sample lines fails, an empty vector is returned without any indication that sampling failed. The evidence shows no samples, looking identical to "samples exist but were empty."

## Current State
Both "no samples to show" and "couldn't fetch samples" result in `Vec::new()`. Users reviewing low-confidence entries can't tell if samples are missing because they don't exist or because gathering failed.

## Desired State
Use `Option<Vec<String>>` for sample lines where:
- `Some(vec![...])` - Samples were fetched successfully
- `Some(vec![])` - No samples exist (file has no matching lines)
- `None` - Sampling failed (permission error, rg crash, etc.)

Alternatively, add a `samples_available: bool` field to `SearchResult`.

## Acceptance Criteria
- [x] Evidence structure distinguishes "no samples" from "sampling failed"
- [x] Verification prompt can include note when samples unavailable
- [x] JSON output shows sampling status

## Technical Notes
**Location:** `src/verification/scanner.rs:251-277`

Consider adding to `KeywordMatch` struct:
```rust
pub struct KeywordMatch {
    pub keyword: String,
    pub files_found: Vec<String>,
    pub occurrence_count: usize,
    pub sample_lines: Option<Vec<String>>,  // None = failed to fetch
    pub appears_complete: bool,
}
```

---

## Resolution

**Completed:** 2026-01-27

### Approach
Changed `sample_lines` from `Vec<String>` to `Option<Vec<String>>` following the existing pattern used by `count: Option<usize>` in `SearchResult`. This uses Rust's type system to express the three-state semantics: `Some(vec![...])` = samples fetched, `Some(vec![])` = no matching lines, `None` = sampling failed.

### Changes Made
- `src/verification/evidence.rs`: Changed `KeywordMatch::sample_lines` from `Vec<String>` to `Option<Vec<String>>`
- `src/verification/scanner.rs`: Changed `SearchResult::samples` from `Vec<String>` to `Option<Vec<String>>`; updated `search_keyword` match arms to return `Some(...)` on success and `None` on failure
- `src/claude/prompt.rs`: Added note in verification prompt instructing the LLM reviewer that `null` sample_lines means sampling failed, not absence of evidence
- Updated all tests in `evidence.rs`, `scanner.rs`, and `prompt.rs` to use `Some(vec![])` or `Some(vec![...])` as appropriate

### Testing
- [x] Build passes (`cargo build`)
- [x] All 272 tests pass (`cargo test`)
- [x] JSON serialization correctly outputs `null` for `None` and `[...]` for `Some(...)`

---
*Solved by Claude Code*
