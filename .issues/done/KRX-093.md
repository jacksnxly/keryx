---
id: "KRX-093"
title: "Reduce code duplication in retry, router, and JSON extraction"
type: improvement
status: in-review
priority: medium
labels: ["code-quality"]
created: "2026-02-02"
updated: "2026-02-02"
assignee: null
---

# Reduce code duplication in retry, router, and JSON extraction

## Context
The LLM version bump feature introduces ~225 lines of duplicated code across retry logic, router fallback, completion structs, subprocess wrappers, and JSON extraction. This duplication increases maintenance burden and risk of divergent behavior.

## Current Implementation

| Area | Files | Duplication |
|------|-------|------------|
| Retry logic | `claude/retry.rs`, `codex/retry.rs` | 4 copies of identical 30-line retry loop (~90 lines) |
| Router fallback | `llm/router.rs` | `generate_with_runner` and `generate_raw_with_runner` are line-for-line identical (~30 lines) |
| Completion structs | `llm/router.rs` | `LlmCompletion` and `LlmRawCompletion` differ only in `output` type (~10 lines) |
| Subprocess wrappers | `codex/subprocess.rs` | `run_codex` and `run_codex_raw` share timeout/exec/error boilerplate (~20 lines) |
| JSON extraction | `claude/retry.rs`, `codex/retry.rs`, `version/llm_bump.rs` | 3 JSON extractors, the newest being a weaker reimplementation (~30 lines) |
| Envelope unwrapping | `claude/retry.rs` | `unwrap_claude_envelope` and `parse_claude_response` duplicate envelope logic (~15 lines) |

## Proposed Improvement
1. **Generic `LlmCompletion<T>`**: Replace `LlmCompletion` and `LlmRawCompletion` with `LlmCompletion<T>` and type aliases
2. **Shared retry helper**: Extract `retry_with_backoff` into `src/llm/retry.rs`, parameterized over error type and transform
3. **Unified `try_with_fallback`**: Factor router fallback into a single generic method
4. **Shared JSON extraction**: Move `extract_json`/`find_valid_json_object`/`extract_balanced_braces` into `src/llm/json.rs`
5. **Extract `run_codex_command`**: Shared subprocess helper that `run_codex` and `run_codex_raw` delegate to
6. **Refactor `parse_claude_response`**: Use `unwrap_claude_envelope` to eliminate duplicated envelope logic

## Acceptance Criteria
- [ ] `LlmCompletion<T>` replaces both completion structs
- [ ] Single retry helper used by all 4 retry functions
- [ ] Single router fallback method used by both `generate` and `generate_raw`
- [ ] Shared JSON extraction module used by Claude, Codex, and llm_bump
- [ ] All existing tests pass
- [ ] No behavioral changes

## Technical Notes
- Estimated ~225 lines of duplication eliminated
- Each refactoring is independent and can be done incrementally
- The `ProviderRunner` trait can remain as-is (2 methods is acceptable)
- Flagged by: code-simplifier, type-design-analyzer

---

## Resolution

**Completed:** 2026-02-02

### Approach
Extracted shared abstractions for JSON extraction, retry logic, router fallback, and subprocess execution. Each refactoring was done independently and verified incrementally.

### Changes Made
- `src/llm/json.rs` (new): Shared JSON extraction with `extract_json`, `find_valid_json_object`, `extract_balanced_braces` — replaces 3 duplicate implementations
- `src/llm/retry.rs` (new): Generic `retry_with_backoff` function with exponential backoff — replaces 4 duplicate retry loops
- `src/llm/mod.rs`: Added exports for `json` and `retry` modules
- `src/llm/router.rs`: Unified `LlmCompletion<T>` with default type parameter, `LlmRawCompletion` is now a type alias. Single `try_with_fallback` method replaces two identical fallback methods
- `src/claude/retry.rs`: Uses shared `retry_with_backoff` and `extract_json`, removed ~80 lines of duplicated code
- `src/codex/retry.rs`: Uses shared `retry_with_backoff` and `extract_json`, removed ~100 lines of duplicated code
- `src/codex/subprocess.rs`: Extracted `run_codex_command` helper, `run_codex` and `run_codex_raw` delegate to it
- `src/version/llm_bump.rs`: Uses shared `extract_json` (fixes latent nested-JSON bug from naive `find`/`rfind` approach)

### Testing
- [x] Build passes (0 warnings)
- [x] All 355 tests pass (249 unit + 106 integration)
- [x] No behavioral changes (except improved JSON extraction robustness in version bump)

---
*Solved by Claude Code*
